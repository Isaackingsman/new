---
title: "new report"
author: "Lee Che Yuet Isaac"
date: "2023-04-17"
output:
  pdf_document: default
  word_document: default
  html_document: default
---

**some of the codes have been hiden for easier reading purpose**

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r Working directory setting and clearing environment, message=FALSE, include=FALSE, results='hide'}
#getwd()
#setwd()
#rm(list=ls())
#gc()
```
```{r Loading packages, message=FALSE, warning=FALSE, include=FALSE}
# required packages
packages <- c('readr','dplyr', 'AER','stargazer','haven','cem','Matching','MatchIt','cobalt','rgenoud','optmatch','Rglpk')

# install any packages that are not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load required packages
invisible(lapply(packages, library, character.only = TRUE))
```
```{r Loading the em dataset as tibble, message=FALSE, warning=FALSE, include=FALSE}
# load dataset: email_mobilization
email_mobilization <- read_csv("subset_finalAnalysisFile20170711.csv") %>% # need to change the folder path
  as_tibble()
# Have a glimpse on the dataset.
head(email_mobilization)
```

# Email mobilization

## Experimental groups

1.  `0`: Control  
2.  `1`: Election Information  
3.  `2`: Social Pressure  
4.  `3`: Native Threat  
5.  `4`: Latino Group Threat. 

## Counting experimental groups by treatment

```{r em Counting experimental groups by treatment}
count(email_mobilization, treat)
```
```{r em Data cleaning, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_cleaned <- email_mobilization %>%
  filter(registered_prior == 'TRUE' & validEmail == T & treat != 'NA') %>%
  mutate(historyCode2016 = if_else(is.na(historyCode2016),'N',historyCode2016)) %>%
  filter(historyCode2016 != 'E') %>%
  mutate(treated = case_when(treat == 0 ~ 0,
                             treat > 0 ~ 1),
         democrat = case_when(major_party == 1 ~ 1,
                              major_party != 1 ~ 0),
         republican = case_when(major_party == 2 ~ 1,
                              major_party != 2 ~ 0),
         party_other = case_when(major_party == 3 ~ 1,
                              major_party != 3 ~ 0),
         female = if_else(gender == "F", 1,0),
         non_white = if_else(minority == 1,1,0),
         outcome = if_else(outcome == TRUE, 1,0),
         congressionalDistrict = factor(congressionalDistrict),
         race = factor(race))

head(em_cleaned)
```
## Summary Statistics
```{r em Summary Statistics, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
em_cleaned %>%
  # turn binary indicators into factors so that we can get more useful summaries
  mutate(gender = factor(gender), 
         party = factor(party), 
         voterStatus = factor(voterStatus),
         general16 = factor(general16),
         outcome = factor(outcome),
         historyCode2016 = factor(historyCode2016), 
         recent = factor(recent),
         likely = factor(likely),
         general12 = factor(general12),
         treat = factor(treat),
         registered_prior = factor(registered_prior),
         minority = factor(minority),
         major_party = factor(major_party),
         validEmail = factor(validEmail),
         pastGeneral = factor(pastGeneral),
         historyCode2016 = factor(historyCode2016),
         treated = factor(treated),
         democrat = factor(democrat),
         republican = factor(republican),
         party_other = factor(party_other),
         female = factor(female),
         non_white= factor(non_white)) %>%
  summary()
```
## Control vs Treatment
### Regression estimate
```{r em Experimental benchmark by regression, message=FALSE, warning=FALSE, paged.print=TRUE}
model_em_1 <- lm(outcome ~ treated, data = em_cleaned)
summary(model_em_1)
```
It has shown that the estimate of the ATT is -0.005071, with a p-value of 0.0058.

### Control regression estimate

Try adding other covariates into the regression and see

```{r em Experimental benchmark by regression with control, message=FALSE, warning=FALSE, paged.print=TRUE}
model_em_2 <- lm(outcome ~ treated + 
                   age +
                   female +
                   race +
                   party +
                   congressionalDistrict +
                   historyCode2016 +
                   general12, data = em_cleaned)
summary(model_em_2)
```

The estimate of the ATT in this regression model with control variables is 9.214e-15 and a p-value of 0.65061, which is drastically different from the previous estimate. It could be impacted by the control variables tremendously.

### Covariate balance
```{r em Covariate balance, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
em_vars <- c("treated", "female","race", "party", "congressionalDistrict",    "historyCode2016", "general12", "age")
em_covs1 <- na.omit(em_cleaned[,em_vars])
bal.tab(em_covs1, treat = em_covs1$treated)
```
From the above covariate balance table, we can observe that the unadjusted differences of the covariates are not drastically different. One of the possible reasons is the datasets has a large amount of observations. The difference presented by the balance table between the control group and the treatment group could be reduced by the it. We can observe what will happen if different matching methods are applied on the dataset.

The Three chosen matching methods are Nearest Neighbor Matching, Exact Matching and Coarsened Exact Matching.

### Nearest neighbour matching
```{r em Matching preparation, message=FALSE, warning=FALSE, include=FALSE}
em_cem1_var <- c("treated", "female","race", "party", "congressionalDistrict",    "historyCode2016", "general12","age", "outcome")
em_data1 <- na.omit(em_cleaned[,em_cem1_var])

em_X_1 <- em_data1 %>%
  dplyr::select(treated, female,race, party, congressionalDistrict,    historyCode2016, general12)
```
```{r em NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_m.out.nnm <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em_data1, 
                        replace = TRUE, 
                        method = "nearest")
em_bal_tab_nnm <- bal.tab(em_m.out.nnm, thresholds = c(m = 0.01), un = TRUE, binary = "std")
em_bal_tab_nnm
```
```{r em Love plot after NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lp.nnm <- love.plot(
  em_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = em_data1$treated,
  covs = em_X_1)

em_lp.nnm
```

From the covariate balance table, we can see a large number of the adjusted difference are larger than the unadjusted difference, it may because of nearest neighbor matching does not give up treatment units that are far from being exactly matched, still match with the closest comparable unit.
#### ATT estimate by nearest neighbor matching
```{r em Reproducing the dataset after NNM, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_m.data.nnm <- match.data(em_m.out.nnm)
head(em_m.data.nnm)
```
```{r em Basic regression after NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.nnm1 <- lm(outcome ~ treated, data = em_m.data.nnm)
summary(em_lm.nnm1)
```
The estimate for the ATT after using nearest neighbor matching is 0.0190735, which has a p-value of less than 2e^-16. 

### Exact matching
```{r em EXA, message=FALSE, warning=FALSE, paged.print=TRUE}
em_m.out.exa <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em_data1, 
                        method = "exact")
em_bal_tab_exa <- bal.tab(em_m.out.exa, thresholds = c(m = 0.01), un = TRUE)
em_bal_tab_exa
```
```{r em Love plot after EXA, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lp.exa <- love.plot(
  em_m.out.exa,
  threshold = .01,
  binary = 'std',
  treat = em_data1$treated,
  covs = em_X_1)

em_lp.exa
```

From the covariate balance table and loveplot, we can see that all of the adjusted difference are reduced to 0, it is because the unmatched units are all dropped.

#### ATT estimate by exact matching
```{r em Reproducing the dataset after EXA, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_m.data.exa <- match.data(em_m.out.exa)
head(em_m.data.exa)
```
```{r em Basic regression after EXA, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.exa1 <- lm(outcome ~ treated, data = em_m.data.exa)
summary(em_lm.exa1)
```

The estimate for the ATT after using exact matching is 0.0190735, which has a p-value of less than 2e^-16. 

### Coarsened Exact Matching

```{r em CEM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_m.out.cem <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age,
                     data = em_data1, method = "cem")

em_bal_tab_cem <- bal.tab(em_m.out.cem, thresholds = c(m = 0.01), un = TRUE)
em_bal_tab_cem
```
```{r em Love plot after CEM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lp.cem <- love.plot(
  em_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = em_data1$treated,
  covs = em_X_1)

em_lp.cem
```

From the covariate balance table, we can see that most of the adjusted difference are reduced to 0, with the only exception of age, which is a continuous variable and may have a higher difficulty of being perfectly matched with too many possible discrete values.

From the loveplot, we can observe that all of the adjusted differences is smaller than the unadjusted difference.
#### ATT by coarsened exact matching
```{r em Reproducing the dataset after CEM, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_m.data.cem <- match.data(em_m.out.cem)
head(em_m.data.cem)
```
```{r em Basic regression after CEM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.cem1 <- lm(outcome ~ treated, data = em_m.data.cem)
summary(em_lm.cem1)
```

The estimate for the ATT after using coarsened exact matching is 0.0213522, which has a p-value of less than 2e^-16. 

### Comparing the ATT results from different matching
```{r Generating em regression results after matching, message=FALSE, warning=FALSE}
# export regression result
stargazer(model_em_1, em_lm.nnm1, em_lm.exa1, em_lm.cem1,
          type="text",
          title="Regression results after matching em",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating em regression results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_em_1, em_lm.nnm1, em_lm.exa1, em_lm.cem1,
          type="html",
          title="Regression results after matching em",
          out="regression_results_after_matching_em.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```

The above table shows the ATT estimate from unmatched sample, nearest neighbor matching sample, exacting matching sample and coarsened exact matching sample respectively. All of them have a p-value less than 0.01. While the unmatched sample has an -0.0051 estimate, the 3 matching samples produced a much higher estimate of 0.00192, 0.0191 and 0.0214 respectively. 

## Black voters
```{r em Counting Race Black}
count(em_cleaned, race)
```

`3`: Black  

### Regression estimate
Creating a basic and preliminary estimate of the treatment effect.
```{r em_b Experimental benchmark by regression,message=FALSE, warning=FALSE, paged.print=TRUE}
em_b_cleaned <- em_cleaned %>%
  filter(race == 3)

model_em_b_1 <- lm(outcome ~ treated, data = em_b_cleaned)
summary(model_em_b_1)
```

### Covariate balance
```{r em_b Covariate balance ,message=FALSE, warning=FALSE, paged.print=TRUE}
em_b_vars <- c("treated", "female","party", "congressionalDistrict", "historyCode2016", "general12", "age")
em_b_covs1 <- na.omit(em_b_cleaned[,em_b_vars])
bal.tab(em_b_covs1, treat = em_b_covs1$treated)
```

### Nearest neighbour matching
```{r em_b Matching preparation, message=FALSE, warning=FALSE, include=FALSE}
em_b_cem1_var <- c("treated", 
                   "female", 
                   "party", 
                   "congressionalDistrict", 
                   "historyCode2016", 
                   "general12",
                   "age", 
                   "outcome")
em_b_data1 <- na.omit(em_b_cleaned[,em_b_cem1_var])

em_b_X_1 <- em_b_data1 %>%
  dplyr::select(treated, female, party, congressionalDistrict, historyCode2016, general12)
```
```{r em_b NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_b_m.out.nnm <- matchit(treated ~ female +
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em_b_data1, 
                        replace = TRUE, 
                        method = "nearest")
em_b_bal_tab_nnm <- bal.tab(em_b_m.out.nnm, thresholds = c(m = 0.01), un = TRUE, binary = "std")
em_b_bal_tab_nnm
```

```{r em_b Love plot after NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_b_lp.nnm <- love.plot(
  em_b_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = em_b_data1$treated,
  covs = em_b_X_1)

em_b_lp.nnm
```

#### ATT estimate by nearest neighbor matching
```{r em_b Reproducing the dataset after NNM, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_b_m.data.nnm <- match.data(em_b_m.out.nnm)
head(em_b_m.data.nnm)
```
```{r em_b Basic regression after NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_b_lm.nnm1 <- lm(outcome ~ treated, data = em_b_m.data.nnm)
summary(em_b_lm.nnm1)
```

### Exact matching
```{r em_b EXA, message=FALSE, warning=FALSE, paged.print=TRUE}
em_b_m.out.exa <- matchit(treated ~ female+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em_b_data1, 
                        method = "exact")
em_b_bal_tab_exa <- bal.tab(em_b_m.out.exa, thresholds = c(m = 0.01), un = TRUE)
em_b_bal_tab_exa
```
```{r em_b Love plot after EXA, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
em_b_lp.exa <- love.plot(
  em_b_m.out.exa,
  threshold = .01,
  binary = 'std',
  treat = em_b_data1$treated,
  covs = em_b_X_1)

em_b_lp.exa
```

From the covariate balance table and loveplot, we can see that all of the adjusted difference are reduced to 0, it is because the unmatched units are all dropped.

#### ATT estimate by exact matching
```{r em_b Reproducing the dataset after EXA, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_b_m.data.exa <- match.data(em_b_m.out.exa)
head(em_b_m.data.exa)
```
```{r em_b Basic regression after EXA, message=FALSE, warning=FALSE, paged.print=TRUE}
em_b_lm.exa1 <- lm(outcome ~ treated, data = em_b_m.data.exa)
summary(em_b_lm.exa1)
```

The estimate for the ATT after using exact matching is 0.0190735, which has a p-value of less than 2e^-16. 

### Coarsened Exact Matching

```{r em_b CEM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_b_m.out.cem <- matchit(treated ~ female +
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age,
                     data = em_b_data1, method = "cem")

em_b_bal_tab_cem <- bal.tab(em_b_m.out.cem, thresholds = c(m = 0.01), un = TRUE)
em_b_bal_tab_cem
```
```{r em_b Love plot after CEM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
em_b_lp.cem <- love.plot(
  em_b_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = em_b_data1$treated,
  covs = em_b_X_1)

em_b_lp.cem
```

From the covariate balance table, we can see that most of the adjusted difference are reduced to 0, with the only exception of age, which is a continuous variable and may have a higher difficulty of being perfectly matched with too many possible discrete values.

From the loveplot, we can observe that all of the adjusted differences is smaller than the unadjusted difference.
#### ATT by coarsened exact matching
```{r em_b Reproducing the dataset after CEM, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_b_m.data.cem <- match.data(em_b_m.out.cem)
head(em_b_m.data.cem)
```
```{r em_b Basic regression after CEM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_b_lm.cem1 <- lm(outcome ~ treated, data = em_b_m.data.cem)
summary(em_b_lm.cem1)
```

The estimate for the ATT after using coarsened exact matching is 0.0213522, which has a p-value of less than 2e^-16. 

### Comparing the ATT results from different matching
```{r Generating em_b regression results after matching, message=FALSE, warning=FALSE}
# export regression result
stargazer(model_em_b_1, em_b_lm.nnm1, em_b_lm.exa1, em_b_lm.cem1,
          type="text",
          title="Regression results after matching em_b",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating em_b regression results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_em_b_1, em_b_lm.nnm1, em_b_lm.exa1, em_b_lm.cem1,
          type="html",
          title="Regression results after matching em_b",
          out="regression_results_after_matching_em_b.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```

## Latino voters
```{r em Counting Race Latino}
count(em_cleaned, race)
```

`4`: Latino  

### Regression estimate
Creating a basic and preliminary estimate of the treatment effect.
```{r em_l Experimental benchmark by regression,message=FALSE, warning=FALSE, paged.print=TRUE}
em_l_cleaned <- em_cleaned %>%
  filter(race == 4)

model_em_l_1 <- lm(outcome ~ treated, data = em_l_cleaned)
summary(model_em_l_1)
```

### Covariate balance
```{r em_l Covariate balance ,message=FALSE, warning=FALSE, paged.print=TRUE}
em_l_vars <- c("treated", "female","party", "congressionalDistrict", "historyCode2016", "general12", "age")
em_l_covs1 <- na.omit(em_l_cleaned[,em_l_vars])
bal.tab(em_l_covs1, treat = em_l_covs1$treated)
```

### Nearest neighbour matching
```{r em_l Matching preparation, message=FALSE, warning=FALSE, include=FALSE}
em_l_cem1_var <- c("treated", 
                   "female", 
                   "party", 
                   "congressionalDistrict", 
                   "historyCode2016", 
                   "general12",
                   "age", 
                   "outcome")
em_l_data1 <- na.omit(em_l_cleaned[,em_l_cem1_var])

em_l_X_1 <- em_l_data1 %>%
  dplyr::select(treated, female, party, congressionalDistrict,    historyCode2016, general12)
```
```{r em_l NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_l_m.out.nnm <- matchit(treated ~ female +
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em_l_data1, 
                        replace = TRUE, 
                        method = "nearest")
em_l_bal_tab_nnm <- bal.tab(em_l_m.out.nnm, thresholds = c(m = 0.01), un = TRUE, binary = "std")
em_l_bal_tab_nnm
```

```{r em_l Love plot after NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_l_lp.nnm <- love.plot(
  em_l_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = em_l_data1$treated,
  covs = em_l_X_1)

em_l_lp.nnm
```

#### ATT estimate by nearest neighbor matching
```{r em_l Reproducing the dataset after NNM, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_l_m.data.nnm <- match.data(em_l_m.out.nnm)
head(em_l_m.data.nnm)
```
```{r em_l Basic regression after NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_l_lm.nnm1 <- lm(outcome ~ treated, data = em_l_m.data.nnm)
summary(em_l_lm.nnm1)
```

### Exact matching
```{r em_l EXA, message=FALSE, warning=FALSE, paged.print=TRUE}
em_l_m.out.exa <- matchit(treated ~ female+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em_l_data1, 
                        method = "exact")
em_l_bal_tab_exa <- bal.tab(em_l_m.out.exa, thresholds = c(m = 0.01), un = TRUE)
em_l_bal_tab_exa
```
```{r em_l Love plot after EXA, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
em_l_lp.exa <- love.plot(
  em_l_m.out.exa,
  threshold = .01,
  binary = 'std',
  treat = em_l_data1$treated,
  covs = em_l_X_1)

em_l_lp.exa
```

From the covariate balance table and loveplot, we can see that all of the adjusted difference are reduced to 0, it is because the unmatched units are all dropped.

#### ATT estimate by exact matching
```{r em_l Reproducing the dataset after EXA, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_l_m.data.exa <- match.data(em_l_m.out.exa)
head(em_l_m.data.exa)
```
```{r em_l Basic regression after EXA, message=FALSE, warning=FALSE, paged.print=TRUE}
em_l_lm.exa1 <- lm(outcome ~ treated, data = em_l_m.data.exa)
summary(em_l_lm.exa1)
```

The estimate for the ATT after using exact matching is 0.0190735, which has a p-value of less than 2e^-16. 

### Coarsened Exact Matching
```{r em_l CEM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_l_m.out.cem <- matchit(treated ~ female +
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age,
                     data = em_l_data1, method = "cem")

em_l_bal_tab_cem <- bal.tab(em_l_m.out.cem, thresholds = c(m = 0.01), un = TRUE)
em_l_bal_tab_cem
```
```{r em_l Love plot after CEM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
em_l_lp.cem <- love.plot(
  em_l_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = em_l_data1$treated,
  covs = em_l_X_1)

em_l_lp.cem
```

From the covariate balance table, we can see that most of the adjusted difference are reduced to 0, with the only exception of age, which is a continuous variable and may have a higher difficulty of being perfectly matched with too many possible discrete values.

From the loveplot, we can observe that all of the adjusted differences is smaller than the unadjusted difference.
#### ATT by coarsened exact matching
```{r em_l Reproducing the dataset after CEM, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_l_m.data.cem <- match.data(em_l_m.out.cem)
head(em_l_m.data.cem)
```
```{r em_l Basic regression after CEM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_l_lm.cem1 <- lm(outcome ~ treated, data = em_l_m.data.cem)
summary(em_l_lm.cem1)
```

The estimate for the ATT after using coarsened exact matching is 0.0213522, which has a p-value of less than 2e^-16. 

### Comparing the ATT results from different matching
```{r Generating em_l regression results after matching, message=FALSE, warning=FALSE}
# export regression result
stargazer(model_em_l_1, em_l_lm.nnm1, em_l_lm.exa1, em_l_lm.cem1,
          type="text",
          title="Regression results after matching em_l",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating em_l regression results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_em_l_1, em_l_lm.nnm1, em_l_lm.exa1, em_l_lm.cem1,
          type="html",
          title="Regression results after matching em_l",
          out="regression_results_after_matching_em_l.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```

# Vaccine incentives
```{r vi Loading the dataset as tibble, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
# load dataset
vaccine_incentives <- read_delim("analysis_ready.csv",
delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% # need to change the folder path
  as_tibble()

#glimpse
head(vaccine_incentives)
```
## Experimental groups by treatment
```{r vi Counting experimental groups by treatment}
count(vaccine_incentives, Treatment)
```
```{r vi Counting experimental groups by names}
count(vaccine_incentives, Treatment2)
```

Control: treatment1(CDC Health Information)  
Treatment version 1: treatment2(Lottery Incentive)  
Treatment version 2: treatment3(Cash Voucher Incentive)  
```{r vi Data cleaning, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
vi_cleaned <- vaccine_incentives %>%
  mutate(
    Treatment = case_when(Treatment == 'treatment1' ~ 0,
                              Treatment == 'treatment2' ~ 1,
                              Treatment == 'treatment3' ~ 2),
    gender = factor(gender),
    race = factor(Race),
    education = factor(Education),
    pool = factor(pool),
    outcome = if_else(clicked == 1, 1, 0),
    treated = if_else( Treatment > 0, 1, 0),
    Treatment_012 = factor(Treatment),
    state = factor(state),
    Trumphi = factor(Trumphi)) %>%
  rename(duration = 'Duration (in seconds)') %>%
  dplyr::select(Treatment_012,
                gender,
                race,
                education,
                pool,
                Trumppercent,
                Trumphi,
                age,
                outcome,
                treated,
                state,
                duration)

head(vi_cleaned)
```
## Summary statistics of whole dataset
```{r vi Summary statistics of whole dataset}
vi_cleaned %>%
  mutate(
    outcome = factor(outcome),
    treated = factor(treated)
  ) %>%
  summary()
```

## Control vs Treatment 1 & 2 (vi)
### Regression estimate
Creating a basic and preliminary estimate of the treatment effect.
```{r vi Experimental benchmark basic regression}
model_vi_1 <- lm(outcome ~ treated, data = vi_cleaned)
summary(model_vi_1)
```

### Control Regression
Try adding other covariates into the regression and see.
```{r vi Experimental benchmark regression with control}
model_vi_2 <- lm(outcome ~ treated +
                   gender + 
                   race +
                   education +
                   pool +
                   Trumppercent +
                   age +
                   state
                 , data = vi_cleaned)
summary(model_vi_2)
```

### Covariate balance
```{r vi Covariate balance, message=FALSE, warning=FALSE}
vi_covs1 <- vi_cleaned %>%
  dplyr::select(gender,
                race,
                education,
                pool,
                Trumppercent,
                Trumphi,
                age,
                outcome,
                treated,
                state) %>%
  na.omit()

bal.tab(vi_covs1, treat = vi_covs1$treated)
```

```{r vi Matching covariates, message=FALSE, warning=FALSE, include=FALSE}
vi_data1 <- na.omit(vi_cleaned)

vi_X_1 <- vi_data1 %>%
  dplyr::select(gender,
                race,
                education,
                pool,
                Trumphi,
                age,
                treated,
                state)
```

### Nearest neighbour matching
```{r vi NNM}
vi_m.out.nnm <- matchit(treated ~ gender +
                race +
                education +
                pool +
                Trumphi +
                age +
                state, 
                data = vi_data1, 
                replace = TRUE, 
                method = "nearest")
vi_bal_tab_nnm <- bal.tab(vi_m.out.nnm, thresholds = c(m = 0.01), un = TRUE, binary = "std")
vi_bal_tab_nnm
```
```{r vi Love plot after NNM}
vi_lp.nnm <- love.plot(
  vi_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = vi_data1$treated,
  covs = vi_X_1)

vi_lp.nnm
```

#### ATT estimate by nearest neighbor matching
```{r vi Reproducing the dataset after NNM, include=FALSE}
vi_m.data.nnm <- match.data(vi_m.out.nnm)
head(vi_m.data.nnm)
```
```{r vi Basic regression after NNM}
vi_lm.nnm1 <- lm(outcome ~ treated, data = vi_m.data.nnm)
summary(vi_lm.nnm1)
```

### Exact matching
```{r vi EXA, message=FALSE, warning=FALSE}
vi_m.out.exa <- matchit(treated ~ gender +
                race +
                education +
                pool +
                Trumphi +
                age +
                state, 
                data = vi_data1, 
                method = "exact")
vi_bal_tab_exa <- bal.tab(vi_m.out.exa, thresholds = c(m = 0.01), un = TRUE)
vi_bal_tab_exa
```

```{r vi Love plot of EXA}
vi_lp.exa <- love.plot(
  vi_m.out.exa,
  threshold = .01,
  binary = 'std',
  treat = vi_data1$treated,
  covs = vi_X_1)

vi_lp.exa
```

#### ATT estimate by exact matchin
```{r vi Reproducing the dataset after EXA, include=FALSE}
vi_m.data.exa <- match.data(vi_m.out.exa)
head(vi_m.data.exa)
```
```{r vi Basic regression after exact}
vi_lm.exa1 <- lm(outcome ~ treated, data = vi_m.data.exa)
summary(vi_lm.exa1)
```

### Coarsened Exact Matching
```{r vi CEM}
vi_m.out.cem <- matchit(treated ~ gender +
                race +
                education +
                pool +
                Trumphi +
                age +
                state,
                data = vi_data1,
                method = "cem")

vi_bal_tab_cem <- bal.tab(vi_m.out.cem,
                       thresholds = c(m = 0.01),
                       un = TRUE)
vi_bal_tab_cem
```

```{r vi Love plot after CEM}
vi_lp.cem <- love.plot(
  vi_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = vi_data1$treated,
  covs = vi_X_1)

vi_lp.cem
```

#### ATT estimate by coarsened exact matching
```{r vi Reproducing the dataset after CEM, include=FALSE}
vi_m.data.cem <- match.data(vi_m.out.cem)
head(vi_m.data.cem)
```
```{r vi Basic regression after CEM}
vi_lm.cem1 <- lm(outcome ~ treated, data = vi_m.data.cem)
summary(vi_lm.cem1)
```

### Comparing the ATT results from different matching
```{r vi Generating vi regression results after matching, message=FALSE, warning=FALSE}
# export regression result
stargazer(model_vi_1, vi_lm.nnm1, vi_lm.exa1, vi_lm.cem1,
          type="text",
          title="Regression results after matching vi",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r vi Generating vi regression results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_vi_1, vi_lm.nnm1, vi_lm.exa1, vi_lm.cem1, 
          type="html",
          title="Regression results after matching vi",
          out="regression_results_after_matching_vi.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
## Control vs Treatment 1 only (vi1)  
### Regression estimate
Creating a basic and preliminary estimate of the treatment effect.
```{r vi1 Creating a subset of control and treatment 1 only}
vi1_cleaned <- vi_cleaned %>%
  filter(Treatment_012 != 2)

count(vi1_cleaned, Treatment_012)
```

```{r vi1 Experimental benchmark regression}
model_vi1_1 <- lm(outcome ~ treated, data = vi1_cleaned)
summary(model_vi1_1)
```

Try adding other covariates into the regression and see
```{r vi1 Experimental benchmark regression with control}
model_vi1_2 <- lm(outcome ~ treated +
                   gender + 
                   race +
                   education +
                   pool +
                   Trumppercent +
                   age +
                   state, data = vi1_cleaned)
summary(model_vi1_2)
```

### Covariate balance
```{r vi1 Covariate balance, message=FALSE, warning=FALSE}
vi1_covs1 <- vi1_cleaned %>%
  dplyr::select(gender,
                race,
                education,
                pool,
                Trumppercent,
                Trumphi,
                age,
                outcome,
                treated,
                state) %>%
  na.omit()

bal.tab(vi1_covs1, treat = vi1_covs1$treated)
```

```{r vi1 Matching covariates,message=FALSE, warning=FALSE, include=FALSE}
vi1_data1 <- na.omit(vi1_cleaned)

vi1_X_1 <- vi1_data1 %>%
  dplyr::select(gender,
                race,
                education,
                pool,
                Trumphi,
                age,
                treated,
                state)
```
### Nearest neighbour matching
```{r vi1 NNM}
vi1_m.out.nnm <- matchit(treated ~ gender +
                race +
                education +
                pool +
                Trumphi +
                age +
                state, 
                data = vi1_data1, 
                replace = TRUE, 
                method = "nearest")
vi1_bal_tab_nnm <- bal.tab(vi1_m.out.nnm, thresholds = c(m = 0.01), un = TRUE, binary = "std")
vi1_bal_tab_nnm
```
```{r vi1 Love plot after NNM}
vi1_lp.nnm <- love.plot(
  vi1_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = vi1_data1$treated,
  covs = vi1_X_1)

vi1_lp.nnm
```

#### ATT estimate by nearest neighbor matching
```{r vi1 Reproducing the dataset after NNM, include=FALSE}
vi1_m.data.nnm <- match.data(vi1_m.out.nnm)
head(vi1_m.data.nnm)
```
```{r vi1 Basic regression after NNM}
vi1_lm.nnm1 <- lm(outcome ~ treated, data = vi1_m.data.nnm)
summary(vi1_lm.nnm1)
```

### Exact matching
```{r vi1 EXA, message=FALSE, warning=FALSE}
vi1_m.out.exa <- matchit(treated ~ gender +
                race +
                education +
                pool +
                Trumphi +
                age +
                state, 
                data = vi1_data1, 
                method = "exact")
vi1_bal_tab_exa <- bal.tab(vi1_m.out.exa, thresholds = c(m = 0.01), un = TRUE)
vi1_bal_tab_exa
```

```{r vi1 Love plot of EXA}
vi1_lp.exa <- love.plot(
  vi1_m.out.exa,
  threshold = .01,
  binary = 'std',
  treat = vi1_data1$treated,
  covs = vi1_X_1)

vi1_lp.exa
```

#### ATT estimate by exact matching
```{r vi1 Reproducing the dataset after EXA, include=FALSE}
vi1_m.data.exa <- match.data(vi1_m.out.exa)
head(vi1_m.data.exa)
```

```{r vi1 Basic regression after EXA}
vi1_lm.exa1 <- lm(outcome ~ treated, data = vi1_m.data.exa)
summary(vi1_lm.exa1)
```

### Coarsened Exact Matching
```{r vi1 CEM}
vi1_m.out.cem <- matchit(treated ~ gender +
                race +
                education +
                pool +
                Trumphi +
                age +
                state,
                data = vi1_data1,
                method = "cem")

vi1_bal_tab_cem <- bal.tab(vi1_m.out.cem,
                       thresholds = c(m = 0.01),
                       un = TRUE)
vi1_bal_tab_cem
```

```{r vi1 Love plot after CEM}
vi1_lp.cem <- love.plot(
  vi1_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = vi1_data1$treated,
  covs = vi1_X_1)

vi1_lp.cem
```

#### ATT estimate by coarsened exact matching
```{r vi1 Reproducing the dataset after CEM, include=FALSE}
vi1_m.data.cem <- match.data(vi1_m.out.cem)
head(vi1_m.data.cem)
```
```{r vi1 Basic regression after CEM}
vi1_lm.cem1 <- lm(outcome ~ treated, data = vi1_m.data.cem)
summary(vi1_lm.cem1)
```

### Comparing the ATT results from different matching
```{r vi1 Generating vi regression results after matching, message=FALSE, warning=FALSE}
# export regression result
stargazer(model_vi1_1, vi1_lm.nnm1, vi1_lm.exa1, vi1_lm.cem1,
          type="text",
          title="Regression results after matching vi1",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r vi1 Generating vi regression results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_vi1_1, vi1_lm.nnm1, vi1_lm.exa1, vi1_lm.cem1, 
          type="html",
          title="Regression results after matching vi1",
          out="regression_results_after_matching_vi1.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
## Control vs Treatment 2 only (vi2)
Creating a basic and preliminary estimate of the treatment effect.
```{r vi2 Creating a subset of control and treatment 2 only}
vi2_cleaned <- vi_cleaned %>%
  filter(Treatment_012 != 1)

count(vi2_cleaned, Treatment_012)
```

### Regression estimate
Creating a basic and preliminary estimate of the treatment effect.
```{r vi2 Experimental benchmark regression}
model_vi2_1 <- lm(outcome ~ treated, data = vi2_cleaned)
summary(model_vi2_1)
```

### Control Regression
Try adding other covariates into the regression and see.
```{r vi2 Experimental benchmark regression with control}
model_vi2_2 <- lm(outcome ~ treated +
                   gender + 
                   race +
                   education +
                   pool +
                   Trumppercent +
                   age +
                   state,
                  data = vi_cleaned)
summary(model_vi2_2)
```

### Covariate balance
```{r vi2 Covariate balance, message=FALSE, warning=FALSE}
vi2_covs1 <- vi2_cleaned %>%
  dplyr::select(gender,
                race,
                education,
                pool,
                Trumppercent,
                Trumphi,
                age,
                outcome,
                treated,
                state) %>%
  na.omit()

bal.tab(vi2_covs1, treat = vi2_covs1$treated)
```
```{r vi2 matching covariates, message=FALSE, warning=FALSE, include=FALSE}
vi2_data1 <- na.omit(vi2_cleaned)

vi2_X_1 <- vi2_data1 %>%
  dplyr::select(gender,
                race,
                education,
                pool,
                Trumphi,
                age,
                treated,
                state)
```
### Nearest neighbour matching
```{r vi2 NNM}
vi2_m.out.nnm <- matchit(treated ~ gender +
                race +
                education +
                pool +
                Trumphi +
                age +
                state, 
                data = vi2_data1, 
                replace = TRUE, 
                method = "nearest")
vi2_bal_tab_nnm <- bal.tab(vi2_m.out.nnm, thresholds = c(m = 0.01), un = TRUE, binary = "std")
vi2_bal_tab_nnm
```
```{r vi2 Love plot after NNM}
vi2_lp.nnm <- love.plot(
  vi2_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = vi2_data1$treated,
  covs = vi2_X_1)

vi2_lp.nnm
```

#### ATT estimate by nearest neighbor matching
```{r vi2 Reproducing the dataset after NNM, include=FALSE}
vi2_m.data.nnm <- match.data(vi2_m.out.nnm)
head(vi2_m.data.nnm)
```
```{r vi2 Basic regression after NNM}
vi2_lm.nnm1 <- lm(outcome ~ treated, data = vi2_m.data.nnm)
summary(vi2_lm.nnm1)
```

### Exact matching
```{r vi2 EXA, message=FALSE, warning=FALSE}
vi2_m.out.exa <- matchit(treated ~ gender +
                race +
                education +
                pool +
                Trumphi +
                age +
                state, 
                data = vi2_data1, 
                method = "exact")
vi2_bal_tab_exa <- bal.tab(vi2_m.out.exa, thresholds = c(m = 0.01), un = TRUE)
vi2_bal_tab_exa
```

```{r vi2 Love plot of EXA}
vi2_lp.exa <- love.plot(
  vi2_m.out.exa,
  threshold = .01,
  binary = 'std',
  treat = vi2_data1$treated,
  covs = vi2_X_1)

vi2_lp.exa
```

#### ATT estimate by exact matching
```{r vi2 Reproducing the dataset after EXA, include=FALSE}
vi2_m.data.exa <- match.data(vi2_m.out.exa)
head(vi2_m.data.exa)
```
```{r vi2 Basic regression after EXA}
vi2_lm.exa1 <- lm(outcome ~ treated, data = vi2_m.data.exa)
summary(vi2_lm.exa1)
```

### Coarsened Exact Matching
```{r vi2 CEM}
vi2_m.out.cem <- matchit(treated ~ gender +
                race +
                education +
                pool +
                Trumphi +
                age +
                state,
                data = vi2_data1,
                method = "cem")

vi2_bal_tab_cem <- bal.tab(vi2_m.out.cem,
                       thresholds = c(m = 0.01),
                       un = TRUE)
vi2_bal_tab_cem
```
```{r vi2 Love plot after CEM}
vi2_lp.cem <- love.plot(
  vi2_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = vi2_data1$treated,
  covs = vi2_X_1)

vi2_lp.cem
```

#### ATT estimate by coarsened exact matching
```{r vi2 Reproducing the dataset after CEM, include=FALSE}
vi2_m.data.cem <- match.data(vi2_m.out.cem)
head(vi2_m.data.cem)
```
```{r vi2 Basic regression after CEM}
vi2_lm.cem1 <- lm(outcome ~ treated, data = vi2_m.data.cem)
summary(vi2_lm.cem1)
```

### Comparing the ATT results from different matching
```{r vi2 Generating vi regression results after matching, message=FALSE, warning=FALSE}
# export regression result
stargazer(model_vi2_1, vi2_lm.nnm1, vi2_lm.exa1, vi2_lm.cem1,
          type="text",
          title="Regression results after matching vi2",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r vi2 Generating vi regression results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_vi2_1, vi2_lm.nnm1, vi2_lm.exa1, vi2_lm.cem1, 
          type="html",
          title="Regression results after matching vi2",
          out="regression_results_after_matching_vi2.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```

