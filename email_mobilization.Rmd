---
title: "MidtermReport"
author: "Lee Che Yuet Isaac"
date: "3/31/2023"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

# Progress so far

Preparation for the datasets are almost done, then can be moved on to the matching phase. There is a minor problem regarding including states as a covariate for matching, which is still considering for a solution.

# Initialization
```{r working directory setting and clearing environment, results = 'hide', message = FALSE}
#getwd()
#setwd()
#rm(list=ls())
#gc()
```
```{r Loading packages ,message=FALSE, warning=FALSE, include=FALSE}
# required packages
packages <- c('readr','dplyr', 'AER','stargazer','haven','cem','Matching','MatchIt','cobalt','rgenoud','optmatch','Rglpk')

# install any packages that are not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load required packages
invisible(lapply(packages, library, character.only = TRUE))
```
# Email mobilization
## Loading the dataset as tibble
```{r Loading the dataset as tibble, message=FALSE, warning=FALSE}
# load dataset: email_mobilization
email_mobilization <- read_csv("subset_finalAnalysisFile20170711.csv") %>% # need to change the folder path
  as_tibble()
# Have a glimpse on the dataset.
head(email_mobilization)
```
Look into the distribution of the experimental groups.
```         
1.  `0`: Control  
2.  `1`: Election Information  
3.  `2`: Social Pressure  
4.  `3`: Native Threat  
5.  `4`: Latino Group Threat.  
```
```{r Counting experimental groups by treatment}
count(email_mobilization, treat)
```
## Data cleaning
```{r Data cleaning, message=FALSE, warning=FALSE, paged.print=TRUE}
em_cleaned <- email_mobilization %>%
  filter(registered_prior == 'TRUE' & validEmail == T & treat != 'NA') %>%
  mutate(historyCode2016 = if_else(is.na(historyCode2016),'N',historyCode2016)) %>%
  filter(historyCode2016 != 'E') %>%
  mutate(treated = case_when(treat == 0 ~ 0,
                             treat > 0 ~ 1),
         democrat = case_when(major_party == 1 ~ 1,
                              major_party != 1 ~ 0),
         republican = case_when(major_party == 2 ~ 1,
                              major_party != 2 ~ 0),
         party_other = case_when(major_party == 3 ~ 1,
                              major_party != 3 ~ 0),
         female = if_else(gender == "F", 1,0),
         non_white = if_else(minority == 1,1,0),
         outcome = if_else(outcome == TRUE, 1,0))

head(em_cleaned)
```
## Summary statistics of the whole dataset
Some of the variables are binary indicators so they are converted into factors.
```{r Summary Statistics ,message=FALSE, warning=FALSE, paged.print=TRUE}
em_cleaned %>%
  # turn binary indicators into factors so that we can get more useful summaries
  mutate(gender = factor(gender), 
         race = factor(race),
         party = factor(party), 
         voterStatus = factor(voterStatus),
         congressionalDistrict = factor(congressionalDistrict),
         general16 = factor(general16),
         outcome = factor(outcome),
         historyCode2016 = factor(historyCode2016), 
         recent = factor(recent),
         likely = factor(likely),
         general12 = factor(general12),
         treat = factor(treat),
         registered_prior = factor(registered_prior),
         minority = factor(minority),
         major_party = factor(major_party),
         validEmail = factor(validEmail),
         pastGeneral = factor(pastGeneral),
         historyCode2016 = factor(historyCode2016),
         treated = factor(treated),
         democrat = factor(democrat),
         republican = factor(republican),
         party_other = factor(party_other),
         female = factor(female),
         non_white= factor(non_white)) %>%
  summary()
```
## Control vs Treatment
### Experimental benchmark
Creating a basic and preliminary estimate of the treatment effect.
```{r Experimental benchmark by regression,message=FALSE, warning=FALSE, paged.print=TRUE}
model_em_1 <- lm(outcome ~ treated, data = em_cleaned)
summary(model_em_1)
```
Try adding other covariates into the regression and see
```{r Experimental benchmark by regression with control ,message=FALSE, warning=FALSE, paged.print=TRUE}
model_em_2 <- lm(outcome ~ treated + 
                   age +
                   female +
                   race +
                   party +
                   congressionalDistrict +
                   historyCode2016 +
                   general12, data = em_cleaned)
summary(model_em_2)
```
### Matching preparation
```{r CEM preparation ,message=FALSE, warning=FALSE, paged.print=TRUE}
em_tr <- which(em_cleaned$treated == 1)
em_ct <- which(em_cleaned$treated == 0)
em_ntr <- length(em_tr)
em_ntr
em_nct <- length(em_ct)
em_nct
```
### Basic estimate
```{r Basic estimate, message=FALSE, warning=FALSE, paged.print=TRUE}
mean(na.omit(em_cleaned$outcome[em_tr])) - mean(na.omit(em_cleaned$outcome[em_ct]))
```
### Covariate balance
```{r Covariate balance, message=FALSE, warning=FALSE, paged.print=TRUE}
em_vars <- c("treated", "female","race", "party", "congressionalDistrict",    "historyCode2016", "general12", "age")
em_covs1 <- na.omit(em_cleaned[,em_vars])
bal.tab(em_covs1, treat = em_covs1$treated)
```
### Coarsened Exact Matching
```{r CEM , message=FALSE, warning=FALSE, paged.print=TRUE}
em_cem1_var <- c("treated", "female","race", "party", "congressionalDistrict",    "historyCode2016", "general12","age", "outcome")
em_data1 <- na.omit(em_cleaned[,em_cem1_var])

em_X_1 <- em_data1 %>%
  dplyr::select(treated, female,race, party, congressionalDistrict,    historyCode2016, general12)

em_m.out.cem <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age,
                     data = em_data1, method = "cem")

em_bal_tab_cem <- bal.tab(em_m.out.cem, thresholds = c(m = 0.01), un = TRUE)
em_bal_tab_cem
```
```{r Love plot after CEM ,message=FALSE, warning=FALSE, paged.print=TRUE}
em_lp.cem <- love.plot(
  em_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = em_data1$treated,
  covs = em_X_1)

em_lp.cem
```
#### ATT by CEM
```{r Reproducing the dataset after CEM,message=FALSE, warning=FALSE, paged.print=TRUE}
em_m.data.cem <- match.data(em_m.out.cem)
head(em_m.data.cem)
```
#### CEM regression
```{r Basic regression after CEM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.cem1 <- lm(outcome ~ treated, data = em_m.data.cem)
summary(em_lm.cem1)
```
```{r Regression with control after CEM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.cem2 <- lm(outcome ~ treated + 
                   age +
                   female +
                   race +
                   party +
                   congressionalDistrict +
                   historyCode2016 +
                   general12, data = em_m.data.cem)
summary(em_lm.cem2)
```
### Exact matching
```{r Exact matching, message=FALSE, warning=FALSE, paged.print=TRUE}
set.seed(1)
em_m.out.exa <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em_data1, 
                        method = "exact")
em_bal_tab_exa <- bal.tab(em_m.out.exa, thresholds = c(m = 0.01), un = TRUE)
em_bal_tab_exa
```
```{r Love plot after exact matching, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lp.exa <- love.plot(
  em_m.out.exa,
  threshold = .1,
  binary = 'std',
  treat = em_data1$treated,
  covs = em_X_1)

em_lp.exa
```
#### ATT by CEM
```{r Reproducing the dataset after EXA,message=FALSE, warning=FALSE, paged.print=TRUE}
em_m.data.exa <- match.data(em_m.out.exa)
head(em_m.data.exa)
```
#### EXa regression
```{r Basic regression after exa, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.exa1 <- lm(outcome ~ treated, data = em_m.data.exa)
summary(em_lm.exa1)
```
```{r Regression with control after exa, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.exa2 <- lm(outcome ~ treated + 
                   age +
                   female +
                   race +
                   party +
                   congressionalDistrict +
                   historyCode2016 +
                   general12, data = em_m.data.exa)
summary(em_lm.exa2)
```
### Nearest neighbour matching
```{r NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_m.out.nnm <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em_data1, 
                        replace = TRUE, 
                        method = "nearest")
em_bal_tab_nnm <- bal.tab(em_m.out.nnm, thresholds = c(m = 0.01), un = TRUE)
em_bal_tab_nnm
```
```{r Love plot after NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lp.nnm <- love.plot(
  em_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = em_data1$treated,
  covs = em_X_1
)

em_lp.nnm
```
#### ATT by NNM
```{r Reproducing the dataset after NNM,message=FALSE, warning=FALSE, paged.print=TRUE}
em_m.data.nnm <- match.data(em_m.out.nnm)
head(em_m.data.nnm)
```
#### NNM regression
```{r Basic regression after NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.nnm1 <- lm(outcome ~ treated, data = em_m.data.nnm)
summary(em_lm.nnm1)
```
```{r Regression with control after NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.nnm2 <- lm(outcome ~ treated + 
                   age +
                   female +
                   race +
                   party +
                   congressionalDistrict +
                   historyCode2016 +
                   general12, data = em_m.data.nnm)
summary(em_lm.nnm2)
```

### Comparing the ATT results from different matching
```{r Generating em regression results after matching, message=FALSE, warning=FALSE}
# export regression result
stargazer(model_em_1, em_lm.cem1, em_lm.exa1, em_lm.nnm1, 
          type="text",
          title="Regression results after matching em",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating em regression results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_em_1, em_lm.cem1, em_lm.exa1, em_lm.nnm1, 
          type="html",
          title="Regression results after matching em",
          out="regression_results_after_matching_em.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```

### Comparing the regression with control results from different matching
```{r Generating em regression with control results after matching, message=FALSE, warning=FALSE, paged.print=TRUE}
# export regression result
stargazer(model_em_2, em_lm.cem2, em_lm.exa2, em_lm.nnm2, 
          type="text",
          title="Regression with control results after matching em",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating em regression with control results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_em_2, em_lm.cem2, em_lm.exa2, em_lm.nnm2, 
          type="html",
          title="Regression with control results after matching em",
          out="regression_results_with_control_after_matching_em.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```


## Control vs Treatment 1 (em1)  
### Experimental benchmark  
Creating a basic and preliminary estimate of the treatment effect.
```{r Experimental benchmark by regression of em1 ,message=FALSE, warning=FALSE, paged.print=TRUE}
em1_cleaned <- em_cleaned %>%
  filter(treat < 2)

model_em1_1 <- lm(outcome ~ treated, data = em1_cleaned)
summary(model_em1_1)
```
Try adding other covariates into the regression and see
```{r Experimental benchmark by regression with control of em1 ,message=FALSE, warning=FALSE, paged.print=TRUE}
model_em1_2 <- lm(outcome ~ treated + 
                   age +
                   female +
                   race +
                   party +
                   congressionalDistrict +
                   historyCode2016 +
                   general12, data = em_cleaned)
summary(model_em1_2)
```
### Matching preparation
```{r em1 CEM preparation ,message=FALSE, warning=FALSE, paged.print=TRUE}
em1_tr <- which(em1_cleaned$treated == 1)
em1_ct <- which(em1_cleaned$treated == 0)
em1_ntr <- length(em1_tr)
em1_ntr
em1_nct <- length(em1_ct)
em1_nct
```
### Basic estimate
```{r Basic estimate of em1, message=FALSE, warning=FALSE, paged.print=TRUE}
mean(na.omit(em1_cleaned$outcome[em1_tr])) - mean(na.omit(em1_cleaned$outcome[em1_ct]))
```
### Covariate balance
```{r Covariate balance of em1,message=FALSE, warning=FALSE, paged.print=TRUE}
em1_vars <- c("treated", "female","race", "party", "congressionalDistrict", "historyCode2016", "general12", "age")
em1_covs1 <- na.omit(em1_cleaned[,em1_vars])
bal.tab(em1_covs1, treat = em1_covs1$treated)
```
### Coarsened Exact Matching
```{r em1 CEM,message=FALSE, warning=FALSE, paged.print=TRUE}
em1_cem1_var <- c("treated", "female","race", "party", "congressionalDistrict",    "historyCode2016", "general12","age", "outcome")
em1_data1 <- na.omit(em1_cleaned[,em1_cem1_var])

em1_X_1 <- em1_data1 %>%
  dplyr::select(treated, female,race, party, congressionalDistrict,    historyCode2016, general12)

em1_m.out.cem <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age,
                     data = em1_data1, method = "cem")

em1_bal_tab_cem <- bal.tab(em1_m.out.cem, thresholds = c(m = 0.01), un = TRUE)
em1_bal_tab_cem
```
```{r Love plot after CEM em1 ,message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lp.cem <- love.plot(
  em1_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = em1_data1$treated,
  covs = em1_X_1)

em1_lp.cem
```
#### ATT by CEM
```{r Reproducing the dataset after CEM em1,message=FALSE, warning=FALSE, paged.print=TRUE}
em1_m.data.cem <- match.data(em1_m.out.cem)
head(em1_m.data.cem)
```
#### CEM regression
```{r Basic regression after CEM em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lm.cem1 <- lm(outcome ~ treated, data = em1_m.data.cem)
summary(em1_lm.cem1)
```
```{r Regression with control after CEM em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lm.cem2 <- lm(outcome ~ treated + 
                   age +
                   female +
                   race +
                   party +
                   congressionalDistrict +
                   historyCode2016 +
                   general12, data = em1_m.data.cem)
summary(em1_lm.cem2)
```
### Exact matching
```{r Exact matching em1, message=FALSE, warning=FALSE, paged.print=TRUE}
set.seed(1)
em1_m.out.exa <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em1_data1, 
                        method = "exact")
em1_bal_tab_exa <- bal.tab(em1_m.out.exa, thresholds = c(m = 0.01), un = TRUE)
em1_bal_tab_exa
```
```{r Love plot after exact matching em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lp.exa <- love.plot(
  em1_m.out.exa,
  threshold = .1,
  binary = 'std',
  treat = em1_data1$treated,
  covs = em1_X_1
)

em1_lp.exa
```
#### ATT by EXA
```{r Reproducing the dataset after EXA em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_m.data.exa <- match.data(em1_m.out.exa)
head(em1_m.data.exa)
```
#### EXA regression
```{r Basic regression after EXA em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lm.exa1 <- lm(outcome ~ treated, data = em1_m.data.exa)
summary(em1_lm.exa1)
```
```{r Regression with control after EXA em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lm.exa2 <- lm(outcome ~ treated + 
                   age +
                   female +
                   race +
                   party +
                   congressionalDistrict +
                   historyCode2016 +
                   general12, data = em1_m.data.exa)
summary(em1_lm.exa2)
```
### Nearest neighbour matching
```{r NNM em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_m.out.nnm <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em1_data1, 
                        replace = TRUE, 
                        method = "nearest")
em1_bal_tab_nnm <- bal.tab(em1_m.out.nnm, thresholds = c(m = 0.01), un = TRUE)
em1_bal_tab_nnm
```
```{r Love plot after NNM em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lp.nnm <- love.plot(
  em1_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = em1_data1$treated,
  covs = em1_X_1
)

em1_lp.nnm
```
#### ATT by NNM
```{r Reproducing the dataset after NNM em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_m.data.nnm <- match.data(em1_m.out.nnm)
head(em1_m.data.nnm)
```
#### NNM regression
```{r Basic regression after NNM em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lm.nnm1 <- lm(outcome ~ treated, data = em1_m.data.nnm)
summary(em1_lm.nnm1)
```
```{r Regression with control after NNM em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lm.nnm2 <- lm(outcome ~ treated + 
                   age +
                   female +
                   race +
                   party +
                   congressionalDistrict +
                   historyCode2016 +
                   general12, data = em1_m.data.nnm)
summary(em1_lm.nnm2)
```
### Comparing the ATT results from different matching
```{r Generating em1 regression results after matching, message=FALSE, warning=FALSE}
# export regression result
stargazer(model_em1_1, em1_lm.cem1, em1_lm.exa1, em1_lm.nnm1, 
          type="text",
          title="Regression results after matching em1",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating em1 regression results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_em1_1, em1_lm.cem1, em1_lm.exa1, em1_lm.nnm1, 
          type="html",
          title="Regression results after matching em1",
          out="regression_results_after_matching_em1.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
### Comparing the regression with control results from different matching
```{r Generating em1 regression with control results after matching, message=FALSE, warning=FALSE, paged.print=TRUE}
# export regression result
stargazer(model_em1_2, em1_lm.cem2, em1_lm.exa2, em1_lm.nnm2, 
          type="text",
          title="Regression with control results after matching em1",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating em1 regression with control results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_em1_2, em1_lm.cem2, em1_lm.exa2, em1_lm.nnm2, 
          type="html",
          title="Regression with control results after matching em1",
          out="regression_results_with_control_after_matching_em1.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```