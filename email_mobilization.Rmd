---
title: "MidtermReport"
author: "Lee Che Yuet Isaac"
date: "3/31/2023"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

# Progress so far

Preparation for the datasets are almost done, then can be moved on to the matching phase. There is a minor problem regarding including states as a covariate for matching, which is still considering for a solution.

# Initialization
```{r working directory setting and clearing environment, results = 'hide', message = FALSE}
#getwd()
#setwd()
#rm(list=ls())
#gc()
```
```{r Loading packages ,message=FALSE, warning=FALSE, include=FALSE}
# required packages
packages <- c('readr','dplyr', 'AER','stargazer','haven','cem','Matching','MatchIt','cobalt','rgenoud','optmatch','Rglpk')

# install any packages that are not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load required packages
invisible(lapply(packages, library, character.only = TRUE))
```
# Email mobilization
## Loading the dataset as tibble
```{r Loading the dataset as tibble, message=FALSE, warning=FALSE}
# load dataset: email_mobilization
email_mobilization <- read_csv("subset_finalAnalysisFile20170711.csv") %>% # need to change the folder path
  as_tibble()
# Have a glimpse on the dataset.
head(email_mobilization)
```
Look into the distribution of the experimental groups.
```         
1.  `0`: Control  
2.  `1`: Election Information  
3.  `2`: Social Pressure  
4.  `3`: Native Threat  
5.  `4`: Latino Group Threat.  
```
```{r Counting experimental groups by treatment}
count(email_mobilization, treat)
```
## Data cleaning
```{r Data cleaning, message=FALSE, warning=FALSE, paged.print=TRUE}
em_cleaned <- email_mobilization %>%
  filter(registered_prior == 'TRUE' & validEmail == T & treat != 'NA') %>%
  mutate(historyCode2016 = if_else(is.na(historyCode2016),'N',historyCode2016)) %>%
  filter(historyCode2016 != 'E') %>%
  mutate(treated = case_when(treat == 0 ~ 0,
                             treat > 0 ~ 1),
         democrat = case_when(major_party == 1 ~ 1,
                              major_party != 1 ~ 0),
         republican = case_when(major_party == 2 ~ 1,
                              major_party != 2 ~ 0),
         party_other = case_when(major_party == 3 ~ 1,
                              major_party != 3 ~ 0),
         female = if_else(gender == "F", 1,0),
         non_white = if_else(minority == 1,1,0),
         outcome = if_else(outcome == TRUE, 1,0))

head(em_cleaned)
```
## Summary statistics of the whole dataset
Some of the variables are binary indicators so they are converted into factors.
```{r Summary Statistics ,message=FALSE, warning=FALSE, paged.print=TRUE}
em_cleaned %>%
  # turn binary indicators into factors so that we can get more useful summaries
  mutate(gender = factor(gender), 
         race = factor(race),
         party = factor(party), 
         voterStatus = factor(voterStatus),
         congressionalDistrict = factor(congressionalDistrict),
         general16 = factor(general16),
         outcome = factor(outcome),
         historyCode2016 = factor(historyCode2016), 
         recent = factor(recent),
         likely = factor(likely),
         general12 = factor(general12),
         treat = factor(treat),
         registered_prior = factor(registered_prior),
         minority = factor(minority),
         major_party = factor(major_party),
         validEmail = factor(validEmail),
         pastGeneral = factor(pastGeneral),
         historyCode2016 = factor(historyCode2016),
         treated = factor(treated),
         democrat = factor(democrat),
         republican = factor(republican),
         party_other = factor(party_other),
         female = factor(female),
         non_white= factor(non_white)) %>%
  summary()
```
## Control vs Treatment 1
###Experimental benchmark
Creating a basic and preliminary estimate of the treatment effect.
```{r Experimental benchmark by regression,message=FALSE, warning=FALSE, paged.print=TRUE}
model_em_1 <- lm(outcome ~ treated, data = em_cleaned)
summary(model_em_1)
```
Try adding other covariates into the regression and see
```{r Experimental benchmark by regression with control ,message=FALSE, warning=FALSE, paged.print=TRUE}
model_em_2 <- lm(outcome ~ treated + 
                   age +
                   female +
                   race +
                   party +
                   congressionalDistrict +
                   historyCode2016 +
                   general12, data = em_cleaned)
summary(model_em_2)
```
### Matching preparation
```{r CEM preparation message=FALSE, warning=FALSE, paged.print=TRUE}
em_tr <- which(em_cleaned$treated == 1)
em_ct <- which(em_cleaned$treated == 0)
em_ntr <- length(em_tr)
em_ntr
em_nct <- length(em_ct)
em_nct
```
### Basic estimate
```{r message=FALSE, warning=FALSE, paged.print=TRUE}
mean(na.omit(em_cleaned$outcome[em_tr])) - mean(na.omit(em_cleaned$outcome[em_ct]))
```
### Covariate balance
```{r message=FALSE, warning=FALSE, paged.print=TRUE}
em_vars <- c("treated", "female","race", "party", "congressionalDistrict",    "historyCode2016", "general12", "age")
em_covs1 <- na.omit(em_cleaned[,em_vars])
bal.tab(em_covs1, treat = em_covs1$treated)
```
### Coarsened Exact Matching
```{r CEM,message=FALSE, warning=FALSE, paged.print=TRUE}
em_cem1_var <- c("treated", "female","race", "party", "congressionalDistrict",    "historyCode2016", "general12","age", "outcome")
em_data1 <- na.omit(em_cleaned[,em_cem1_var])

em_X_1 <- em_data1 %>%
  dplyr::select(treated, female,race, party, congressionalDistrict,    historyCode2016, general12)

em_m.out.cem <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age,
                     data = em_data1, method = "cem")

em_bal_tab_cem <- bal.tab(em_m.out.cem, thresholds = c(m = 0.01), un = TRUE)
em_bal_tab_cem
```
```{r Love plot after CEM ,message=FALSE, warning=FALSE, paged.print=TRUE}
em_lp.cem <- love.plot(
  em_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = em_data1$treated,
  covs = em_X_1)

em_lp.cem
```
### ATT by CEM
```{r Reproducing the dataset after CEM,message=FALSE, warning=FALSE, paged.print=TRUE}
em_m.data.cem <- match.data(em_m.out.cem)
head(em_m.data.cem)
```
### CEM regression
```{r Basic regression after CEM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.cem1 <- lm(outcome ~ treated, data = em_m.data.cem)
summary(em_lm.cem1)
```
```{r Regression with control after CEM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.cem2 <- lm(outcome ~ treated + 
                   age +
                   female +
                   race +
                   party +
                   congressionalDistrict +
                   historyCode2016 +
                   general12, data = em_m.data.cem)
summary(em_lm.cem2)
```
## Genetic matching
```{r Genetic matching, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
set.seed(1)
em_m.out.gen <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em_data1, 
                        replace = TRUE, 
                        method = "genetic")
em_bal_tab_gen <- bal.tab(em_m.out.gen, thresholds = c(m = 0.01), un = TRUE)
em_bal_tab_gen
```
```{r Love plot after genetic matching, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
lp.gen <- love.plot(
  m.out.gen,
  threshold = .1,
  binary = 'std',
  treat = data11$past_pkpres,
  covs = X_11
)

lp.gen
```
## Nearest neighbour matching
```{r NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_m.out.nnm <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em_data1, 
                        replace = TRUE, 
                        method = "nearest")
em_bal_tab_nnm <- bal.tab(em_m.out.nnm, thresholds = c(m = 0.01), un = TRUE)
em_bal_tab_nnm
```
```{r Love plot after NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lp.nnm <- love.plot(
  em_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = em_data1$treated,
  covs = em_X_1
)

em_lp.nnm
```

# To-do:

matching

covariate balance

summary statistics

comparison between the datasets
