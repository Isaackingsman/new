---
title: "new report"
author: "Lee Che Yuet Isaac"
date: "2023-04-17"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

**some of the codes have been hiden for easier reading purpose**

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r working directory setting and clearing environment, message=FALSE, include=FALSE, results='hide'}
#getwd()
#setwd()
#rm(list=ls())
#gc()
```
```{r Loading packages, message=FALSE, warning=FALSE, include=FALSE}
# required packages
packages <- c('readr','dplyr', 'AER','stargazer','haven','cem','Matching','MatchIt','cobalt','rgenoud','optmatch','Rglpk')

# install any packages that are not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load required packages
invisible(lapply(packages, library, character.only = TRUE))
```
```{r Loading the dataset as tibble, message=FALSE, warning=FALSE, include=FALSE}
# load dataset: email_mobilization
email_mobilization <- read_csv("subset_finalAnalysisFile20170711.csv") %>% # need to change the folder path
  as_tibble()
# Have a glimpse on the dataset.
head(email_mobilization)
```

# Email mobilization

## Experimental groups

1.  `0`: Control  
2.  `1`: Election Information  
3.  `2`: Social Pressure  
4.  `3`: Native Threat  
5.  `4`: Latino Group Threat. 

## Counting experimental groups by treatment

```{r Counting experimental groups by treatment}
count(email_mobilization, treat)
```
```{r Data cleaning, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_cleaned <- email_mobilization %>%
  filter(registered_prior == 'TRUE' & validEmail == T & treat != 'NA') %>%
  mutate(historyCode2016 = if_else(is.na(historyCode2016),'N',historyCode2016)) %>%
  filter(historyCode2016 != 'E') %>%
  mutate(treated = case_when(treat == 0 ~ 0,
                             treat > 0 ~ 1),
         democrat = case_when(major_party == 1 ~ 1,
                              major_party != 1 ~ 0),
         republican = case_when(major_party == 2 ~ 1,
                              major_party != 2 ~ 0),
         party_other = case_when(major_party == 3 ~ 1,
                              major_party != 3 ~ 0),
         female = if_else(gender == "F", 1,0),
         non_white = if_else(minority == 1,1,0),
         outcome = if_else(outcome == TRUE, 1,0),
         congressionalDistrict = factor(congressionalDistrict),
         race = factor(race))

head(em_cleaned)
```

## Summary Statistics

```{r Summary Statistics, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
em_cleaned %>%
  # turn binary indicators into factors so that we can get more useful summaries
  mutate(gender = factor(gender), 
         party = factor(party), 
         voterStatus = factor(voterStatus),
         general16 = factor(general16),
         outcome = factor(outcome),
         historyCode2016 = factor(historyCode2016), 
         recent = factor(recent),
         likely = factor(likely),
         general12 = factor(general12),
         treat = factor(treat),
         registered_prior = factor(registered_prior),
         minority = factor(minority),
         major_party = factor(major_party),
         validEmail = factor(validEmail),
         pastGeneral = factor(pastGeneral),
         historyCode2016 = factor(historyCode2016),
         treated = factor(treated),
         democrat = factor(democrat),
         republican = factor(republican),
         party_other = factor(party_other),
         female = factor(female),
         non_white= factor(non_white)) %>%
  summary()
```

## Control vs Treatment

### Regression estimate
```{r Experimental benchmark by regression, message=FALSE, warning=FALSE, paged.print=TRUE}
model_em_1 <- lm(outcome ~ treated, data = em_cleaned)
summary(model_em_1)
```
It has shown that the estimate of the ATT is -0.005071, with a p-value of 0.0058.

### Control regression estimate

Try adding other covariates into the regression and see

```{r Experimental benchmark by regression with control, message=FALSE, warning=FALSE, paged.print=TRUE}
model_em_2 <- lm(outcome ~ treated + 
                   age +
                   female +
                   race +
                   party +
                   congressionalDistrict +
                   historyCode2016 +
                   general12, data = em_cleaned)
summary(model_em_2)
```
The estimate of the ATT in this regression model with control variables is 9.214e-15 and a p-value of 0.65061, which is drastically different from the previous estimate. It could be impacted by the control variables tremendously.

### Covariate balance
```{r Covariate balance, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
em_vars <- c("treated", "female","race", "party", "congressionalDistrict",    "historyCode2016", "general12", "age")
em_covs1 <- na.omit(em_cleaned[,em_vars])
bal.tab(em_covs1, treat = em_covs1$treated)
```
From the above covariate balance table, we can observe that the unadjusted differences of the covariates are not drastically different. One of the possible reasons is the datasets has a large amount of observations. The difference presented by the balance table between the control group and the treatment group could be reduced by the it. We can observe what will happen if different matching methods are applied on the dataset.

The Three chosen matching methods are Nearest Neighbor Matching, Exact Matching and Coarsened Exact Matching.

### Nearest neighbour matching
```{r message=FALSE, warning=FALSE, include=FALSE}
em_cem1_var <- c("treated", "female","race", "party", "congressionalDistrict",    "historyCode2016", "general12","age", "outcome")
em_data1 <- na.omit(em_cleaned[,em_cem1_var])

em_X_1 <- em_data1 %>%
  dplyr::select(treated, female,race, party, congressionalDistrict,    historyCode2016, general12)


```

```{r NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_m.out.nnm <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em_data1, 
                        replace = TRUE, 
                        method = "nearest")
em_bal_tab_nnm <- bal.tab(em_m.out.nnm, thresholds = c(m = 0.01), un = TRUE)
em_bal_tab_nnm
```
```{r Love plot after NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lp.nnm <- love.plot(
  em_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = em_data1$treated,
  covs = em_X_1
)

em_lp.nnm
```

From the covariate balance table, we can see a large number of the adjusted difference are larger than the unadjusted difference, it may because of nearest neighbor matching does not give up treatment units that are far from being exactly matched, still match with the closest comparable unit.

```{r Reproducing the dataset after NNM, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_m.data.nnm <- match.data(em_m.out.nnm)
head(em_m.data.nnm)
```

#### ATT estimate by nearest neighbor matching

```{r Basic regression after NNM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.nnm1 <- lm(outcome ~ treated, data = em_m.data.nnm)
summary(em_lm.nnm1)
```

The estimate for the ATT after using nearest neighbor matching is 0.0190735, which has a p-value of less than 2e^-16. 

### Exact matching
```{r Exact matching, message=FALSE, warning=FALSE, paged.print=TRUE}
em_m.out.exa <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em_data1, 
                        method = "exact")
em_bal_tab_exa <- bal.tab(em_m.out.exa, thresholds = c(m = 0.01), un = TRUE)
em_bal_tab_exa
```

```{r Love plot after exact matching, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lp.exa <- love.plot(
  em_m.out.exa,
  threshold = .1,
  binary = 'std',
  treat = em_data1$treated,
  covs = em_X_1)

em_lp.exa
```

From the covariate balance table and loveplot, we can see that all of the adjusted difference are reduced to 0, it is because the unmatched units are all dropped.

```{r Reproducing the dataset after EXA, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_m.data.exa <- match.data(em_m.out.exa)
head(em_m.data.exa)
```

#### ATT estimate by exact matching

```{r Basic regression after exa, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.exa1 <- lm(outcome ~ treated, data = em_m.data.exa)
summary(em_lm.exa1)
```

The estimate for the ATT after using exact matching is 0.0190735, which has a p-value of less than 2e^-16. 

### Coarsened Exact Matching

```{r CEM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_m.out.cem <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age,
                     data = em_data1, method = "cem")

em_bal_tab_cem <- bal.tab(em_m.out.cem, thresholds = c(m = 0.01), un = TRUE)
em_bal_tab_cem
```
```{r Love plot after CEM, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lp.cem <- love.plot(
  em_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = em_data1$treated,
  covs = em_X_1)

em_lp.cem
```

From the covariate balance table, we can see that most of the adjusted difference are reduced to 0, with the only exception of age, which is a continuous variable and may have a higher difficulty of being perfectly matched with too many possible discrete values.

From the loveplot, we can observe that all of the adjusted differences is smaller than the unadjusted difference.

```{r Reproducing the dataset after CEM, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em_m.data.cem <- match.data(em_m.out.cem)
head(em_m.data.cem)
```

#### ATT by coarsened exact matching

```{r Basic regression after CEM, message=FALSE, warning=FALSE, paged.print=TRUE}
em_lm.cem1 <- lm(outcome ~ treated, data = em_m.data.cem)
summary(em_lm.cem1)
```

The estimate for the ATT after using coarsened exact matching is 0.0213522, which has a p-value of less than 2e^-16. 

### Comparing the ATT results from different matching
```{r Generating em regression results after matching, message=FALSE, warning=FALSE}
# export regression result
stargazer(model_em_1, em_lm.nnm1, em_lm.exa1, em_lm.cem1,
          type="text",
          title="Regression results after matching em",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating em regression results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_em_1, em_lm.nnm1, em_lm.exa1, em_lm.cem1,
          type="html",
          title="Regression results after matching em",
          out="regression_results_after_matching_em.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```

The above table shows the ATT estimate from unmatched sample, nearest neighbor matching sample, exacting matching sample and coarsened exact matching sample respectively. All of them have a p-value less than 0.01. While the unmatched sample has an -0.0051 estimate, the 3 matching samples produced a much higher estimate of 0.00192, 0.0191 and 0.0214 respectively. 

## Control vs Treatment 1 (em1)  

### Regression estimate 
Creating a basic and preliminary estimate of the treatment effect.
```{r Experimental benchmark by regression of em1 ,message=FALSE, warning=FALSE, paged.print=TRUE}
em1_cleaned <- em_cleaned %>%
  filter(treat < 2)

model_em1_1 <- lm(outcome ~ treated, data = em1_cleaned)
summary(model_em1_1)
```

It has shown that the estimate of the ATT is -0.004152, with a p-value of 0.0734.

### Control regression estimate

Try adding other covariates into the regression and see

```{r Experimental benchmark by regression with control of em1 ,message=FALSE, warning=FALSE, paged.print=TRUE}
model_em1_2 <- lm(outcome ~ treated + 
                   age +
                   female +
                   race +
                   party +
                   congressionalDistrict +
                   historyCode2016 +
                   general12, data = em_cleaned)
summary(model_em1_2)
```

It can be observed that the estimate for the treatment indicator has been largely reduced to 9.214e-15 and a p-value of 0.65061, hugely affected by other control variables.

### Covariate balance

```{r Covariate balance of em1,message=FALSE, warning=FALSE, paged.print=TRUE}
em1_vars <- c("treated", "female","race", "party", "congressionalDistrict", "historyCode2016", "general12", "age")
em1_covs1 <- na.omit(em1_cleaned[,em1_vars])
bal.tab(em1_covs1, treat = em1_covs1$treated)
```

From the above covariate balance table, we can observe that the unadjusted differences of the covariates are almost 0. Similar situation to the mentioned analysis.

### Nearest neighbour matching

```{r message=FALSE, warning=FALSE}
em1_cem1_var <- c("treated", "female","race", "party", "congressionalDistrict",    "historyCode2016", "general12","age", "outcome")
em1_data1 <- na.omit(em1_cleaned[,em1_cem1_var])

em1_X_1 <- em1_data1 %>%
  dplyr::select(treated, female,race, party, congressionalDistrict,    historyCode2016, general12)

```


```{r NNM em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_m.out.nnm <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em1_data1, 
                        replace = TRUE, 
                        method = "nearest")
em1_bal_tab_nnm <- bal.tab(em1_m.out.nnm, thresholds = c(m = 0.01), un = TRUE)
em1_bal_tab_nnm
```
```{r Love plot after NNM em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lp.nnm <- love.plot(
  em1_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = em1_data1$treated,
  covs = em1_X_1
)

em1_lp.nnm
```

```{r Reproducing the dataset after NNM em1, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em1_m.data.nnm <- match.data(em1_m.out.nnm)
head(em1_m.data.nnm)
```

#### ATT estimate by nearest neighbor matching

```{r Basic regression after NNM em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lm.nnm1 <- lm(outcome ~ treated, data = em1_m.data.nnm)
summary(em1_lm.nnm1)
```

### Exact matching

```{r Exact matching em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_m.out.exa <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age, 
                        data = em1_data1, 
                        method = "exact")
em1_bal_tab_exa <- bal.tab(em1_m.out.exa, thresholds = c(m = 0.01), un = TRUE)
em1_bal_tab_exa
```
```{r Love plot after exact matching em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lp.exa <- love.plot(
  em1_m.out.exa,
  threshold = .1,
  binary = 'std',
  treat = em1_data1$treated,
  covs = em1_X_1
)

em1_lp.exa
```

#### ATT estimate by exact matching

```{r Reproducing the dataset after EXA em1, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em1_m.data.exa <- match.data(em1_m.out.exa)
head(em1_m.data.exa)
```
```{r Basic regression after EXA em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lm.exa1 <- lm(outcome ~ treated, data = em1_m.data.exa)
summary(em1_lm.exa1)
```

### Coarsened Exact Matching

```{r em1 CEM,message=FALSE, warning=FALSE, paged.print=TRUE}
em1_cem1_var <- c("treated", "female","race", "party", "congressionalDistrict",    "historyCode2016", "general12","age", "outcome")
em1_data1 <- na.omit(em1_cleaned[,em1_cem1_var])

em1_X_1 <- em1_data1 %>%
  dplyr::select(treated, female,race, party, congressionalDistrict,    historyCode2016, general12)

em1_m.out.cem <- matchit(treated ~ female +
                          race+
                          party+
                          congressionalDistrict+
                          historyCode2016+
                          general12 + 
                          age,
                     data = em1_data1, method = "cem")

em1_bal_tab_cem <- bal.tab(em1_m.out.cem, thresholds = c(m = 0.01), un = TRUE)
em1_bal_tab_cem
```
```{r Love plot after CEM em1 ,message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lp.cem <- love.plot(
  em1_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = em1_data1$treated,
  covs = em1_X_1)

em1_lp.cem
```

#### ATT estimate by CEM

```{r Reproducing the dataset after CEM em1, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
em1_m.data.cem <- match.data(em1_m.out.cem)
head(em1_m.data.cem)
```
```{r Basic regression after CEM em1, message=FALSE, warning=FALSE, paged.print=TRUE}
em1_lm.cem1 <- lm(outcome ~ treated, data = em1_m.data.cem)
summary(em1_lm.cem1)
```
### Comparing the ATT results from different matching
```{r Generating em1 regression results after matching, message=FALSE, warning=FALSE}
# export regression result
stargazer(model_em1_1, em1_lm.nnm1, em1_lm.exa1, em1_lm.cem1,  
          type="text",
          title="Regression results after matching em1",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating em1 regression results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_em1_1, em1_lm.nnm1, em1_lm.exa1, em1_lm.cem1, 
          type="html",
          title="Regression results after matching em1",
          out="regression_results_after_matching_em1.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```

# Vaccine incentives
```{r Loading the dataset as tibble, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
# load dataset
vaccine_incentives <- read_delim("analysis_ready.csv",
delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% # need to change the folder path
  as_tibble()

#glimpse
head(vaccine_incentives)
```

## Experimental groups by treatment

```{r Counting experimental groups by treatment}
count(vaccine_incentives, Treatment)
```
```{r Counting experimental groups by names}
count(vaccine_incentives, Treatment2)
```

Control: treatment1(CDC Health Information)  
Treatment version 1: treatment2(Lottery Incentive)  
Treatment version 2: treatment3(Cash Voucher Incentive)  
















