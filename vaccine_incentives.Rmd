---
title: "MidtermReport"
author: "Lee Che Yuet Isaac"
date: "3/31/2023"
output:
  html_document: default
  pdf_document: default
  word_document: default
---
# Progress so far

Preparation for the datasets are almost done, then can be moved on to the matching phase. There is a minor problem regarding including states as a covariate for matching, which is still considering for a solution.




# Initialization
```{r working directory setting and clearing environment, results = 'hide', message = FALSE}
#getwd()
#setwd()
#rm(list=ls())
#gc()
```
```{r Loading packages ,message=FALSE, warning=FALSE, include=FALSE}
# required packages
packages <- c('readr','dplyr', 'AER','stargazer','haven','cem','Matching','MatchIt','cobalt','rgenoud','optmatch','Rglpk')

# install any packages that are not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load required packages
invisible(lapply(packages, library, character.only = TRUE))
```
# Vaccine incentives
## Loading the dataset as tibble
```{r Loading the dataset as tibble,message=FALSE, warning=FALSE, paged.print=TRUE}
# load dataset
vaccine_incentives <- read_delim("analysis_ready.csv",
delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% # need to change the folder path
  as_tibble()

#glimpse
head(vaccine_incentives)
```
```{r Counting experimental groups by treatment}
count(vaccine_incentives, Treatment)
```
```{r Counting experimental groups by names}
count(vaccine_incentives, Treatment2)
```

Control: treatment1(CDC Health Information)  
Treatment version 1: treatment2(Lottery Incentive)  
Treatment version 2: treatment3(Cash Voucher Incentive)  

## Data cleaning
```{r Data cleaning, message=FALSE, warning=FALSE, paged.print=TRUE}
vi_cleaned <- vaccine_incentives %>%
  mutate(
    Treatment_012 = case_when(Treatment == 'treatment1' ~ 0,
                             Treatment == 'treatment2' ~ 1,
                             Treatment == 'treatment3' ~ 2),
    Female_10 = case_when(gender == 'Female' ~ 1,
                     gender == 'Male' ~ 0,
                     gender == 'Other' ~ NA_real_),
    age_young_10 = if_else(Age_cat == 'Young', 1, 0),
    race_white_10 = if_else(Race == 'White' , 1, 0),
    race_black_10 = if_else(Race == 'Black' , 1, 0),
    race_other_10 = if_else(Race == 'Other' , 1, 0),
    education_low_10 = if_else(Education == 'Low' , 1, 0),
    education_medium_10 = if_else(Education == 'Medium' , 1, 0),
    education_high_10 = if_else(Education == 'High' , 1,0),
    pool_CloudResearch_10 = if_else(pool == 'CloudResearch' , 1, 0),
    pool_Facebook_10 = if_else(pool == 'Facebook' , 1, 0),
    pool_Lucid_10 = if_else(pool == 'Lucid' , 1, 0),
    outcome = if_else(clicked == 1, 1, 0),
    treated = if_else(Treatment_012 > 0, 1, 0)) %>%
  dplyr::select(Treatment_012,
                Female_10,
                age_young_10,
                race_white_10,
                race_black_10,
                race_other_10,
                education_low_10,
                education_medium_10,
                education_high_10,
                pool_CloudResearch_10,
                pool_Facebook_10,
                pool_Lucid_10,
                Trumppercent,
                Trumphi,
                age,
                outcome,
                treated)

head(vi_cleaned)
```
## Summary statistics of whole dataset
```{r Summary statistics of whole dataset}
vi_cleaned %>%
  mutate(
    Treatment_012 = factor(Treatment_012),
    Female_10 = factor(Female_10),
    age_young_10 = factor(age_young_10),
    race_white_10 = factor(race_white_10),
    race_black_10 = factor(race_black_10),
    race_other_10 = factor(race_other_10),
    education_low_10 = factor(education_low_10),
    education_medium_10 = factor(education_medium_10),
    education_high_10 = factor(education_high_10),
    pool_CloudResearch_10 = factor(pool_CloudResearch_10),
    pool_Facebook_10 = factor(pool_Facebook_10),
    pool_Lucid_10 = factor(pool_Lucid_10),
    Trumppercent,
    Trumphi = factor(Trumphi),
    age,
    outcome = factor(outcome),
    treated = factor(treated)) %>%
  summary() 
```
## Control vs Treatment 1 & 2 (vi)
### Experimental benchmark
Creating a basic and preliminary estimate of the treatment effect.
```{r Experimental benchmark basic regression}
model_vi_1 <- lm(outcome ~ treated, data = vi_cleaned)
summary(model_vi_1)
```
Try adding other covariates into the regression and se
```{r Experimental benchmark regression with control}
model_vi_2 <- lm(outcome ~ treated + 
                   Female_10 +
                   race_white_10 +
                   race_black_10 +
                   education_low_10 +
                   education_medium_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   Trumppercent +
                   age, data = vi_cleaned)
summary(model_vi_2)
```
### Matching preparation
```{r Matching preparation}
vi_tr <- which(vi_cleaned$treated == 1)
vi_ct <- which(vi_cleaned$treated == 0)
vi_ntr <- length(vi_tr)
vi_ntr
vi_nct <- length(vi_ct)
vi_nct
```
### Basic estimate
```{r Basic estimate}
mean(na.omit(vi_cleaned$outcome[vi_tr])) - mean(na.omit(vi_cleaned$outcome[vi_ct]))
```
### Covariate balance
```{r Covariate balance, message=FALSE, warning=FALSE}
vi_covs1 <- vi_cleaned %>%
  dplyr::select(Female_10,
                race_white_10,
                race_black_10,
                race_other_10,
                education_low_10,
                education_medium_10,
                education_high_10,
                pool_CloudResearch_10,
                pool_Facebook_10,
                pool_Lucid_10,
                Trumppercent,
                age,
                treated) %>%
  na.omit()

bal.tab(vi_covs1, treat = vi_covs1$treated)
```
### Coarsened Exact Matching
```{r CEM}
vi_data1 <- na.omit(vi_cleaned)

vi_X_1 <- vi_data1 %>%
  dplyr::select(Female_10,
                race_white_10,
                race_black_10,
                race_other_10,
                education_low_10,
                education_medium_10,
                education_high_10,
                pool_CloudResearch_10,
                pool_Facebook_10,
                pool_Lucid_10,
                Trumppercent,
                age)

vi_m.out.cem <- matchit(treated ~ Female_10 +
                   race_white_10 +
                   race_black_10 +
                   race_other_10 +
                   education_low_10 +
                   education_medium_10 +
                   education_high_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   pool_Lucid_10 +
                   Trumppercent +
                   age,
                   data = vi_data1,
                   method = "cem")

vi_bal_tab_cem <- bal.tab(vi_m.out.cem,
                       thresholds = c(m = 0.01),
                       un = TRUE)
vi_bal_tab_cem
```
```{r Love plot after CEM}
vi_lp.cem <- love.plot(
  vi_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = vi_data1$treated,
  covs = vi_X_1)

vi_lp.cem
```

#### ATT by CEM
```{r Reproducing the dataset after CEM}
vi_m.data.cem <- match.data(vi_m.out.cem)
head(vi_m.data.cem)
```
#### CEM regression 
```{r Basic regression after CEM}
vi_lm.cem1 <- lm(outcome ~ treated, data = vi_m.data.cem)
summary(vi_lm.cem1)
```
```{r Regression with control after CEM}
vi_lm.cem2 <- lm(outcome ~  treated + 
                   Female_10 +
                   race_white_10 +
                   race_black_10 +
                   education_low_10 +
                   education_medium_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   Trumppercent +
                   age, data = vi_m.data.cem)
summary(vi_lm.cem2)
```
### Exact matching
```{r exact matching, message=FALSE, warning=FALSE}
set.seed(1)
vi_m.out.exa <- matchit(treated ~ Female_10 +
                   race_white_10 +
                   race_black_10 +
                   race_other_10 +
                   education_low_10 +
                   education_medium_10 +
                   education_high_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   pool_Lucid_10 +
                   Trumppercent +
                   age, 
                   data = vi_data1, 
                   method = "exact")
vi_bal_tab_exa <- bal.tab(vi_m.out.exa, thresholds = c(m = 0.01), un = TRUE)
vi_bal_tab_exa
```
```{r Love plot of exact matching}
vi_lp.exa <- love.plot(
  vi_m.out.exa,
  threshold = .01,
  binary = 'std',
  treat = vi_data1$treated,
  covs = vi_X_1)

vi_lp.exa
```

#### ATT by exact
```{r Reproducing the dataset after exact}
vi_m.data.exa <- match.data(vi_m.out.exa)
head(vi_m.data.exa)
```
#### exact regression 
```{r Basic regression after Geb}
vi_lm.exa1 <- lm(outcome ~ treated, data = vi_m.data.exa)
summary(vi_lm.exa1)
```
```{r Regression with control after exact}
vi_lm.exa2 <- lm(outcome ~  treated + 
                   Female_10 +
                   race_white_10 +
                   race_black_10 +
                   education_low_10 +
                   education_medium_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   Trumppercent +
                   age, data = vi_m.data.exa)
summary(vi_lm.exa2)
```
### Nearest neighbour matching
```{r NNM}
vi_m.out.nnm <- matchit(treated ~ Female_10 +
                   race_white_10 +
                   race_black_10 +
                   race_other_10 +
                   education_low_10 +
                   education_medium_10 +
                   education_high_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   pool_Lucid_10 +
                   Trumppercent +
                   age, 
                   data = vi_data1, 
                   replace = TRUE, 
                   method = "nearest")
vi_bal_tab_nnm <- bal.tab(vi_m.out.nnm, thresholds = c(m = 0.01), un = TRUE)
vi_bal_tab_nnm
```
```{r Love plot after NNM}
vi_lp.nnm <- love.plot(
  vi_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = vi_data1$treated,
  covs = vi_X_1)

vi_lp.nnm
```

#### ATT by NNM
```{r Reproducing the dataset after NNM}
vi_m.data.nnm <- match.data(vi_m.out.nnm)
head(vi_m.data.nnm)
```
#### NNM regression 
```{r Basic regression after NNM}
vi_lm.nnm1 <- lm(outcome ~ treated, data = vi_m.data.nnm)
summary(vi_lm.nnm1)
```
```{r Regression with control after NNM}
vi_lm.nnm2 <- lm(outcome ~  treated + 
                   Female_10 +
                   race_white_10 +
                   race_black_10 +
                   education_low_10 +
                   education_medium_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   Trumppercent +
                   age, data = vi_m.data.nnm)
summary(vi_lm.nnm2)
```

### Comparing the ATT results from different matching
```{r Generating vi regression results after matching, message=FALSE, warning=FALSE}
# export regression result
stargazer(model_vi_1, vi_lm.cem1, vi_lm.exa1, vi_lm.nnm1, 
          type="text",
          title="Regression results after matching vi",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating vi regression results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_vi_1, vi_lm.cem1, vi_lm.exa1, vi_lm.nnm1, 
          type="html",
          title="Regression results after matching vi",
          out="regression_results_after_matching_vi.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```

### Comparing the regression with control results from different matching
```{r Generating vi regression with control results after matching, message=FALSE, warning=FALSE, paged.print=TRUE}
# export regression result
stargazer(model_vi_2, vi_lm.cem2, vi_lm.exa2, vi_lm.nnm2, 
          type="text",
          title="Regression with control results after matching vi",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating vi regression with control results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_vi_2, vi_lm.cem2, vi_lm.exa2, vi_lm.nnm2, 
          type="html",
          title="Regression with control results after matching vi",
          out="regression_results_with_control_after_matching_vi.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```

## Control vs Treatment 1 only (vi1)  
### Experimental benchmark  
Creating a basic and preliminary estimate of the treatment effect.
```{r Creating a subset of control and treatment 1 only}
vi1_cleaned <- vi_cleaned %>%
  filter(Treatment_012 < 2)

count(vi1_cleaned, Treatment_012)
```
```{r vi1 Experimental benchmark regression}
model_vi1_1 <- lm(outcome ~ treated, data = vi1_cleaned)
summary(model_vi1_1)
```
Try adding other covariates into the regression and see
```{r vi1 Experimental benchmark regression with control}
model_vi1_2 <- lm(outcome ~ treated + 
                   Female_10 +
                   race_white_10 +
                   race_black_10 +
                   education_low_10 +
                   education_medium_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   Trumppercent +
                   age, data = vi1_cleaned)
summary(model_vi1_2)
```
### Matching preparation
```{r vi1 Matching preparation}
vi1_tr <- which(vi1_cleaned$Treatment_012 == 1)
vi1_ct <- which(vi1_cleaned$Treatment_012 == 0)
vi1_ntr <- length(vi1_tr)
vi1_ntr
vi1_nct <- length(vi1_ct)
vi1_nct
```
### Basic estimate
```{r vi1 Basic estimate}
mean(na.omit(vi1_cleaned$outcome[vi1_tr])) - mean(na.omit(vi1_cleaned$outcome[vi1_ct]))
```
### Covariate balance
```{r vi1 Covariate balance,message=FALSE, warning=FALSE}
vi1_covs1 <- vi1_cleaned %>%
  dplyr::select(Female_10,
                race_white_10,
                race_black_10,
                race_other_10,
                education_low_10,
                education_medium_10,
                education_high_10,
                pool_CloudResearch_10,
                pool_Facebook_10,
                pool_Lucid_10,
                Trumppercent,
                age,
                treated) %>%
  na.omit()

bal.tab(vi1_covs1, treat = vi1_covs1$treated)
```
### CEM
```{r vi1 CEM}
vi1_data1 <- na.omit(vi1_cleaned)

vi1_X_1 <- vi1_data1 %>%
  dplyr::select(Female_10,
                race_white_10,
                race_black_10,
                race_other_10,
                education_low_10,
                education_medium_10,
                education_high_10,
                pool_CloudResearch_10,
                pool_Facebook_10,
                pool_Lucid_10,
                Trumppercent,
                age)

vi1_m.out.cem <- matchit(treated ~ Female_10 +
                   race_white_10 +
                   race_black_10 +
                   race_other_10 +
                   education_low_10 +
                   education_medium_10 +
                   education_high_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   pool_Lucid_10 +
                   Trumppercent +
                   age,
                   data = vi1_data1,
                   method = "cem")

vi1_bal_tab_cem <- bal.tab(vi1_m.out.cem,
                       thresholds = c(m = 0.01),
                       un = TRUE)
vi1_bal_tab_cem
```
```{r Love plot of vi1 CEM}
vi1_lp.cem <- love.plot(
  vi1_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = vi1_data1$treated,
  covs = vi1_X_1)

vi1_lp.cem
```

#### ATT by CEM
```{r Reproducing the dataset after CEM of vi1}
vi1_m.data.cem <- match.data(vi1_m.out.cem)
head(vi1_m.data.cem)
```
#### CEM regression 
```{r vi1 Basic regression after CEM}
vi1_lm.cem1 <- lm(outcome ~ treated, data = vi1_m.data.cem)
summary(vi1_lm.cem1)
```
```{r vi1 regression with control after CEM }
vi1_lm.cem2 <- lm(outcome ~  treated + 
                   Female_10 +
                   race_white_10 +
                   race_black_10 +
                   education_low_10 +
                   education_medium_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   Trumppercent +
                   age, data = vi1_m.data.cem)
summary(vi1_lm.cem2)
```

### Exact matching
```{r vi1 EXA matching, message=FALSE, warning=FALSE}
set.seed(1)
vi1_m.out.exa <- matchit(treated ~ Female_10 +
                   race_white_10 +
                   race_black_10 +
                   race_other_10 +
                   education_low_10 +
                   education_medium_10 +
                   education_high_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   pool_Lucid_10 +
                   Trumppercent +
                   age, 
                   data = vi1_data1, 
                   method = "exact")
vi1_bal_tab_exa <- bal.tab(vi1_m.out.exa, thresholds = c(m = 0.01), un = TRUE)
vi1_bal_tab_exa
```
```{r Love plot of vi1 exact matching}
vi1_lp.exa <- love.plot(
  vi1_m.out.exa,
  threshold = .01,
  binary = 'std',
  treat = vi1_data1$treated,
  covs = vi1_X_1)

vi1_lp.exa
```

#### ATT by Exa
```{r Reproducing the dataset after Exa vi1}
vi1_m.data.exa <- match.data(vi1_m.out.exa)
head(vi1_m.data.exa)
```
#### Exa regression 
```{r Basic regression after Exa vi1}
vi1_lm.exa1 <- lm(outcome ~ treated, data = vi1_m.data.exa)
summary(vi1_lm.exa1)
```
```{r Regression with control after Exa vi1}
vi1_lm.exa2 <- lm(outcome ~  treated + 
                   Female_10 +
                   race_white_10 +
                   race_black_10 +
                   education_low_10 +
                   education_medium_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   Trumppercent +
                   age, data = vi1_m.data.exa)
summary(vi1_lm.exa2)
```

### Nearest neighbour matching
```{r vi1 NNM}
vi1_m.out.nnm <- matchit(treated ~ Female_10 +
                   race_white_10 +
                   race_black_10 +
                   race_other_10 +
                   education_low_10 +
                   education_medium_10 +
                   education_high_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   pool_Lucid_10 +
                   Trumppercent +
                   age, 
                   data = vi1_data1, 
                   replace = TRUE, 
                   method = "nearest")
vi1_bal_tab_nnm <- bal.tab(vi1_m.out.nnm, thresholds = c(m = 0.01), un = TRUE)
vi1_bal_tab_nnm
```
```{r vi1 Love plot after NNM}
vi1_lp.nnm <- love.plot(
  vi1_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = vi1_data1$treated,
  covs = vi1_X_1)

vi1_lp.nnm
```

#### ATT by NNM
```{r Reproducing the dataset after NNM of vi1}
vi1_m.data.nnm <- match.data(vi1_m.out.nnm)
head(vi1_m.data.nnm)
```

#### NNM regression 
```{r vi1 Basic regression after NNM}
vi1_lm.nnm1 <- lm(outcome ~ treated, data = vi1_m.data.nnm)
summary(vi1_lm.nnm1)
```
```{r vi1 regression with control after NNM }
vi1_lm.nnm2 <- lm(outcome ~  treated + 
                   Female_10 +
                   race_white_10 +
                   race_black_10 +
                   education_low_10 +
                   education_medium_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   Trumppercent +
                   age, data = vi1_m.data.nnm)
summary(vi1_lm.nnm2)
```
### Comparing the ATT results from different matching
```{r Generating vi1 regression results after matching, message=FALSE, warning=FALSE}
# export regression result
stargazer(model_vi1_1, vi1_lm.cem1, vi1_lm.exa1, vi1_lm.nnm1, 
          type="text",
          title="Regression results after matching vi1",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating vi1 regression results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_vi1_1, vi1_lm.cem1, vi1_lm.exa1, vi1_lm.nnm1, 
          type="html",
          title="Regression results after matching vi1",
          out="regression_results_after_matching_vi1.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```

### Comparing the regression with control results from different matching
```{r Generating vi1 regression with control results after matching, message=FALSE, warning=FALSE, paged.print=TRUE}
# export regression result
stargazer(model_vi1_2, vi1_lm.cem2, vi1_lm.exa2, vi1_lm.nnm2, 
          type="text",
          title="Regression with control results after matching vi1",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating vi1 regression with control results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_vi1_2, vi1_lm.cem2, vi1_lm.exa2, vi1_lm.nnm2, 
          type="html",
          title="Regression with control results after matching vi1",
          out="regression_results_with_control_after_matching_vi1.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```


## Control vs Treatment 2 only (vi2)
### Experimental benchmark  
Creating a basic and preliminary estimate of the treatment effect.
```{r Creating a subset of control and treatment 2 only}
vi2_cleaned <- vi_cleaned %>%
  filter(Treatment_012 != 1)

count(vi2_cleaned, Treatment_012)
```
```{r vi2 Experimental benchmark regression}
model_vi2_1 <- lm(outcome ~ treated, data = vi2_cleaned)
summary(model_vi2_1)
```
Try adding other covariates into the regression and see
```{r vi2 Experimental benchmark regression with control}
model_vi2_2 <- lm(outcome ~ treated + 
                   Female_10 +
                   race_white_10 +
                   race_black_10 +
                   education_low_10 +
                   education_medium_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   Trumppercent +
                   age, data = vi2_cleaned)
summary(model_vi2_2)
```
### Matching preparation
```{r vi2 Matching preparation}
vi2_tr <- which(vi2_cleaned$Treatment_012 == 2)
vi2_ct <- which(vi2_cleaned$Treatment_012 == 0)
vi2_ntr <- length(vi2_tr)
vi2_ntr
vi2_nct <- length(vi2_ct)
vi2_nct
```
### Basic estimate
```{r vi2 Basic estimate}
mean(na.omit(vi2_cleaned$outcome[vi2_tr])) - mean(na.omit(vi2_cleaned$outcome[vi2_ct]))
```
### Covariate balance
```{r vi2 Covariate balance,message=FALSE, warning=FALSE}
vi2_covs1 <- vi2_cleaned %>%
  dplyr::select(Female_10,
                race_white_10,
                race_black_10,
                race_other_10,
                education_low_10,
                education_medium_10,
                education_high_10,
                pool_CloudResearch_10,
                pool_Facebook_10,
                pool_Lucid_10,
                Trumppercent,
                age,
                treated) %>%
  na.omit()

bal.tab(vi2_covs1, treat = vi2_covs1$treated)
```
### CEM
```{r vi2 CEM}
vi2_data1 <- na.omit(vi2_cleaned)

vi2_X_1 <- vi2_data1 %>%
  dplyr::select(Female_10,
                race_white_10,
                race_black_10,
                race_other_10,
                education_low_10,
                education_medium_10,
                education_high_10,
                pool_CloudResearch_10,
                pool_Facebook_10,
                pool_Lucid_10,
                Trumppercent,
                age)

vi2_m.out.cem <- matchit(treated ~ Female_10 +
                   race_white_10 +
                   race_black_10 +
                   race_other_10 +
                   education_low_10 +
                   education_medium_10 +
                   education_high_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   pool_Lucid_10 +
                   Trumppercent +
                   age,
                   data = vi2_data1,
                   method = "cem")

vi2_bal_tab_cem <- bal.tab(vi2_m.out.cem,
                       thresholds = c(m = 0.01),
                       un = TRUE)
vi2_bal_tab_cem
```
```{r Love plot of vi2 CEM}
vi2_lp.cem <- love.plot(
  vi2_m.out.cem,
  threshold = .01,
  binary = 'std',
  treat = vi2_data1$treated,
  covs = vi2_X_1)

vi2_lp.cem
```

#### ATT by CEM
```{r Reproducing the dataset after CEM of vi2}
vi2_m.data.cem <- match.data(vi2_m.out.cem)
head(vi2_m.data.cem)
```
#### CEM regression 
```{r vi2 Basic regression after CEM}
vi2_lm.cem1 <- lm(outcome ~ treated, data = vi2_m.data.cem)
summary(vi2_lm.cem1)
```
```{r vi2 regression with control after CEM }
vi2_lm.cem2 <- lm(outcome ~  treated + 
                   Female_10 +
                   race_white_10 +
                   race_black_10 +
                   education_low_10 +
                   education_medium_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   Trumppercent +
                   age, data = vi2_m.data.cem)
summary(vi2_lm.cem2)
```
### Exact matching
```{r vi2 exact matching, message=FALSE, warning=FALSE}
set.seed(1)
vi2_m.out.exa <- matchit(treated ~ Female_10 +
                   race_white_10 +
                   race_black_10 +
                   race_other_10 +
                   education_low_10 +
                   education_medium_10 +
                   education_high_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   pool_Lucid_10 +
                   Trumppercent +
                   age, 
                   data = vi2_data1, 
                   method = "exact")
vi2_bal_tab_exa <- bal.tab(vi2_m.out.exa, thresholds = c(m = 0.01), un = TRUE)
vi2_bal_tab_exa
```
```{r Love plot of vi2 exact matching}
vi2_lp.exa <- love.plot(
  vi2_m.out.exa,
  threshold = .01,
  binary = 'std',
  treat = vi2_data1$treated,
  covs = vi2_X_1)

vi2_lp.exa
```

#### ATT by Exa
```{r Reproducing the dataset after exa vi2}
vi2_m.data.exa <- match.data(vi2_m.out.exa)
head(vi2_m.data.exa)
```
#### exa regression 
```{r Basic regression after exa 2 vi2}
vi2_lm.exa1 <- lm(outcome ~ treated, data = vi2_m.data.exa)
summary(vi2_lm.exa1)
```
```{r Regression with control after exa vi2}
vi2_lm.exa2 <- lm(outcome ~  treated + 
                   Female_10 +
                   race_white_10 +
                   race_black_10 +
                   education_low_10 +
                   education_medium_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   Trumppercent +
                   age, data = vi2_m.data.exa)
summary(vi2_lm.exa2)
```

### Nearest neighbour matching
```{r vi2 NNM}
vi2_m.out.nnm <- matchit(treated ~ Female_10 +
                   race_white_10 +
                   race_black_10 +
                   race_other_10 +
                   education_low_10 +
                   education_medium_10 +
                   education_high_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   pool_Lucid_10 +
                   Trumppercent +
                   age, 
                   data = vi2_data1, 
                   replace = TRUE, 
                   method = "nearest")
vi2_bal_tab_nnm <- bal.tab(vi2_m.out.nnm, thresholds = c(m = 0.01), un = TRUE)
vi2_bal_tab_nnm
```
```{r vi2 Love plot after NNM}
vi2_lp.nnm <- love.plot(
  vi2_m.out.nnm,
  threshold = .01,
  binary = 'std',
  treat = vi2_data1$treated,
  covs = vi2_X_1)

vi2_lp.nnm
```

#### ATT by NNM
```{r Reproducing the dataset after NNM of vi2}
vi2_m.data.nnm <- match.data(vi2_m.out.nnm)
head(vi2_m.data.nnm)
```
#### NNM regression 
```{r vi2 Basic regression after NNM}
vi2_lm.nnm1 <- lm(outcome ~ treated, data = vi2_m.data.nnm)
summary(vi2_lm.nnm1)
```
```{r vi2 regression with control after NNM }
vi2_lm.nnm2 <- lm(outcome ~  treated + 
                   Female_10 +
                   race_white_10 +
                   race_black_10 +
                   education_low_10 +
                   education_medium_10 +
                   pool_CloudResearch_10 +
                   pool_Facebook_10 +
                   Trumppercent +
                   age, data = vi2_m.data.nnm)
summary(vi2_lm.nnm2)
```
### Comparing the ATT results from different matching
```{r Generating vi2 regression results after matching, message=FALSE, warning=FALSE}
# export regression result
stargazer(model_vi2_1, vi2_lm.cem1, vi2_lm.exa1, vi2_lm.nnm1, 
          type="text",
          title="Regression results after matching vi2",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating vi2 regression results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_vi2_1, vi2_lm.cem1, vi2_lm.exa1, vi2_lm.nnm1, 
          type="html",
          title="Regression results after matching vi2",
          out="regression_results_after_matching_vi2.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```

### Comparing the regression with control results from different matching
```{r Generating vi2 regression with control results after matching, message=FALSE, warning=FALSE, paged.print=TRUE}
# export regression result
stargazer(model_vi2_2, vi2_lm.cem2, vi2_lm.exa2, vi2_lm.nnm2, 
          type="text",
          title="Regression with control results after matching vi2",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```
```{r Generating v12 regression with control results after matching .doc, message=FALSE, warning=FALSE, include=FALSE}
# export regression result
stargazer(model_vi2_2, vi2_lm.cem2, vi2_lm.exa2, vi2_lm.nnm2, 
          type="html",
          title="Regression with control results after matching vi2",
          out="regression_results_with_control_after_matching_vi2.doc",
          intercept.bottom = F,
          intercept.top = T,
          digits=4)
```